@startuml Data_Flow_Diagram
!theme plain

title SALLY Data Flow Diagram

skinparam component {
    BackgroundColor<<input>> LightBlue
    BackgroundColor<<process>> LightGreen
    BackgroundColor<<storage>> LightYellow
    BackgroundColor<<output>> LightCoral
}

component "Driver Input\nForm" as driver_input <<input>>
component "Dock Input\nForm" as dock_input <<input>>
component "Route Input\nForm" as route_input <<input>>
component "HOS Parameters\nForm" as hos_input <<input>>

component "Input Validation\n(Zod)" as validation <<process>>
component "API Client\n(React Query)" as api_client <<process>>

component "FastAPI Router" as router <<process>>
component "Request Middleware" as middleware <<process>>

component "HOS Rule Engine" as hos_engine <<process>>
component "Prediction Engine" as pred_engine <<process>>
component "Rest Optimization\nEngine" as opt_engine <<process>>

database "PostgreSQL\nDatabase" as db <<storage>>
database "Redis\nCache" as cache <<storage>>

component "Recommendation\nRepository" as rec_repo <<process>>
component "Driver\nRepository" as driver_repo <<process>>
component "Route\nRepository" as route_repo <<process>>

component "Recommendation\nCard" as rec_card <<output>>
component "Compliance\nChecklist" as compliance <<output>>
component "Metrics\nVisualization" as metrics <<output>>
component "History\nTable" as history <<output>>

' Input Flow
driver_input --> validation : driver_id, hours_driven,\non_duty_time, duty_status
dock_input --> validation : dock_duration,\nlocation
route_input --> validation : remaining_miles,\ndestination, appointments
hos_input --> validation : HOS parameters,\nbreak info

validation --> api_client : Validated\ninput data

api_client --> router : POST /api/v1/\noptimization/recommend\n(JSON payload)

router --> middleware : HTTP Request

' Processing Flow
middleware --> driver_repo : Get driver\nHOS status
driver_repo --> db : SELECT driver\ndata
db --> driver_repo : Driver record

middleware --> route_repo : Get active\nroute
route_repo --> db : SELECT route\ndata
db --> route_repo : Route record

middleware --> hos_engine : Validate\ncompliance
hos_engine --> cache : Check cached\nvalidation
cache --> hos_engine : Cached result\n(if available)
hos_engine --> cache : Store validation\nresult
hos_engine --> middleware : HOS Compliance\nResult

middleware --> pred_engine : Estimate drive\ndemand
pred_engine --> route_repo : Get route\ndetails
route_repo --> pred_engine : Route data
pred_engine --> cache : Check cached\nprediction
cache --> pred_engine : Cached result\n(if available)
pred_engine --> cache : Store prediction
pred_engine --> middleware : Prediction\nResult

middleware --> opt_engine : Generate\nrecommendation
opt_engine --> opt_engine : Analyze dock time\nvs drive demand\nCalculate opportunity
opt_engine --> middleware : Rest\nRecommendation

middleware --> rec_repo : Store\nrecommendation
rec_repo --> db : INSERT INTO\nrecommendations
db --> rec_repo : Recommendation ID

' Output Flow
middleware --> router : Optimization\nResult
router --> api_client : JSON Response\n(200 OK)

api_client --> rec_card : Recommendation\ntype & duration
api_client --> compliance : Compliance\nstatus
api_client --> metrics : Opportunity score,\nremaining hours
api_client --> history : Add to\nexecution history

' Data Labels
note right of validation
  **Validated Fields:**
  - driver_id (string)
  - hours_driven (0-11)
  - on_duty_time (0-14)
  - dock_duration (0-24)
  - remaining_miles (>0)
  - destination (string)
end note

note right of hos_engine
  **HOS Validation:**
  - 11-hour drive limit
  - 14-hour duty window
  - 30-minute break
  - 10-hour rest requirement
  - Sleeper berth eligibility
end note

note right of opt_engine
  **Optimization Logic:**
  IF dock >= 10hrs AND demand <= 3hrs
    RECOMMEND: FULL_REST
  ELSE IF dock >= 7hrs
    RECOMMEND: PARTIAL_REST
  ELSE
    RECOMMEND: NO_REST
end note

note bottom of db
  **Database Tables:**
  - drivers (id, driver_id, hours, status)
  - vehicles (id, vehicle_id, telematics)
  - routes (id, driver_id, distance, destination)
  - events (id, type, timestamp, data)
  - recommendations (id, driver_id, type, duration)
end note

note bottom of cache
  **Cached Data:**
  - HOS validation results (TTL: 5min)
  - Prediction results (TTL: 15min)
  - Session data (TTL: 30min)
end note

@enduml
