# Alerts & Notifications System Design

**Product:** SALLY â€” Your Fleet Operations Assistant
**Date:** February 6, 2026
**Status:** Design Document (Full Vision)
**Author:** Product & Engineering

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Conceptual Model: Alerts vs Notifications](#2-conceptual-model-alerts-vs-notifications)
3. [Alert System Design](#3-alert-system-design)
4. [Notification System Design](#4-notification-system-design)
5. [Alert Generation Engine](#5-alert-generation-engine)
6. [Dispatcher UX â€” Alerts Command Center](#6-dispatcher-ux--alerts-command-center)
7. [Driver UX â€” Mobile-First PWA](#7-driver-ux--mobile-first-pwa)
8. [Notification Center UX](#8-notification-center-ux)
9. [Real-Time Delivery Infrastructure](#9-real-time-delivery-infrastructure)
10. [Settings Architecture â€” Layered System](#10-settings-architecture--layered-system)
11. [Alert Fatigue Prevention](#11-alert-fatigue-prevention)
12. [Data Models](#12-data-models)
13. [API Design](#13-api-design)
14. [Implementation Phases](#14-implementation-phases)

---

## 1. Executive Summary

SALLY is positioned as **the coordination layer between dispatchers and drivers**. The alerts and notifications system is the **nervous system** of this product â€” without it, SALLY is a passive route calculator rather than an active operations assistant.

### The Two Systems

This design introduces **two distinct but related systems**:

| System | Purpose | Primary Audience | UX Location |
|--------|---------|-----------------|-------------|
| **Alerts** | Operational events requiring dispatcher action | Dispatchers, Safety Managers | Dedicated Command Center page |
| **Notifications** | Informational updates for all users | All users (dispatchers, drivers, admins, owners) | Notification Center (bell icon inbox) |

### Why Separate?

- **Alerts** are the dispatcher's workqueue â€” time-sensitive, actionable, with SLAs and escalation
- **Notifications** are everyone's inbox â€” informational, can wait, personal to each user
- Mixing them causes **alert fatigue** (the #1 complaint across Samsara, Motive, and every fleet platform)
- Different lifecycle: Alerts have `active â†’ acknowledged â†’ resolved`; Notifications have `unread â†’ read`
- Different configuration: Alerts have org-wide policies; Notifications have personal preferences

### Key Design Decisions

1. **Replace Command Center** â€” `/dispatcher/overview` becomes the Alerts Command Center
2. **Separate Notification Center** â€” Bell icon opens a notification inbox, distinct from alerts
3. **SSE + WebSocket** â€” SSE for real-time alert/notification push; WebSocket for driver-dispatcher messaging
4. **PWA for Drivers** â€” Mobile web app with push notifications and SMS fallback
5. **Layered Settings** â€” Operations Settings (org-wide) + User Preferences (personal, within org boundaries)
6. **Smart Grouping + Escalation** â€” Prevent alert fatigue while ensuring nothing falls through the cracks
7. **Per-Channel Control** â€” Users choose delivery channel per notification type

---

## 2. Conceptual Model: Alerts vs Notifications

### Alerts â€” Operational Action Items

Alerts represent **events that require human intervention**. They are generated by the monitoring engine when real-world conditions deviate from the plan.

```
Monitoring Engine detects anomaly
    â†“
Alert Generation Engine evaluates rules
    â†“
Alert created (status: active)
    â†“
Real-time push to dispatcher dashboard (SSE)
    â†“
Dispatcher triages and acknowledges
    â†“
Dispatcher takes corrective action
    â†“
Dispatcher resolves alert
    â†“
Audit trail recorded
```

**Characteristics:**
- Generated by the system (never by users)
- Always tied to operational context (driver, route, vehicle)
- Have priority levels (Critical, High, Medium, Low)
- Have SLAs (response time expectations)
- Have escalation paths (unacknowledged â†’ escalate)
- Require acknowledgment and resolution
- Are tenant-scoped (multi-tenant isolation)
- Feed into analytics and compliance reporting

### Notifications â€” Informational Updates

Notifications represent **things users should know about**. They come from many sources and serve all user roles.

```
System event occurs (route planned, user invited, sync complete)
    â†“
Notification Service creates notification
    â†“
Delivery Engine routes to configured channels
    â†“
User sees notification in their inbox
    â†“
User reads and optionally dismisses
```

**Characteristics:**
- Generated by system events, user actions, or admin actions
- Personal to each user (not shared like alerts)
- Have categories (system, team, operations, communications)
- Delivered via user's preferred channels (in-app, email, SMS, push)
- Simple lifecycle: `unread â†’ read â†’ dismissed`
- No SLA or escalation
- User-configurable (opt in/out per type, per channel)

### Visual Distinction

| Aspect | Alerts | Notifications |
|--------|--------|---------------|
| **Icon** | Warning triangle / Shield | Bell |
| **Location** | Command Center page + sidebar indicator | Notification bell dropdown/page |
| **Badge** | Red pulse on sidebar "Alerts" section | Count badge on bell icon |
| **Sound** | Configurable audio for Critical/High | Silent (optional sound for specific types) |
| **Color** | Priority-coded (red/orange/yellow/blue) | Neutral (gray/muted) with category icons |
| **Actions** | Acknowledge, Resolve, Escalate, Snooze | Mark Read, Dismiss, Navigate to context |
| **Persistence** | Permanent (audit trail) | Can be dismissed/archived |

---

## 3. Alert System Design

### 3.1 Alert Taxonomy

#### Category 1: HOS Compliance (Safety-Critical â€” Mandatory, Cannot Be Disabled)

| Alert Type | Priority | Trigger | Proactive? |
|-----------|----------|---------|------------|
| `HOS_VIOLATION` | CRITICAL | Active HOS violation detected | Reactive |
| `HOS_APPROACHING_LIMIT` | HIGH | Drive time remaining < configurable threshold (default: 1hr) | Proactive |
| `BREAK_REQUIRED` | HIGH | 8hrs since last 30-min break, approaching limit | Proactive |
| `CYCLE_APPROACHING_LIMIT` | MEDIUM | 70hr/8-day cycle nearing limit | Proactive |

#### Category 2: Route Progress

| Alert Type | Priority | Trigger | Proactive? |
|-----------|----------|---------|------------|
| `MISSED_APPOINTMENT` | CRITICAL | Missed pickup/delivery time window | Reactive |
| `APPOINTMENT_AT_RISK` | HIGH | ETA exceeds appointment window by > configurable threshold | Proactive |
| `DOCK_TIME_EXCEEDED` | HIGH | Actual dock time > estimated by > configurable threshold (default: 1hr) | Reactive |
| `ROUTE_DELAY` | MEDIUM | ETA delay > configurable threshold (default: 30min) | Reactive |
| `STOP_SEQUENCE_DEVIATION` | MEDIUM | Driver skipped or reordered stops | Reactive |

#### Category 3: Driver Behavior

| Alert Type | Priority | Trigger | Proactive? |
|-----------|----------|---------|------------|
| `DRIVER_NOT_MOVING` | HIGH | No movement for > configurable threshold (default: 2hrs) during drive segment | Reactive |
| `UNEXPECTED_STOP` | MEDIUM | Stopped at non-planned location for > 15 min | Reactive |
| `OFF_ROUTE` | MEDIUM | Driver deviated significantly from planned route | Reactive |

#### Category 4: Vehicle State

| Alert Type | Priority | Trigger | Proactive? |
|-----------|----------|---------|------------|
| `FUEL_LOW` | HIGH | Fuel < configurable threshold (default: 20%) and no fuel stop within range | Proactive |
| `FUEL_STOP_MISSED` | MEDIUM | Driver passed planned fuel stop | Reactive |
| `MAINTENANCE_DUE` | LOW | Vehicle maintenance overdue or approaching | Proactive |

#### Category 5: External Conditions

| Alert Type | Priority | Trigger | Proactive? |
|-----------|----------|---------|------------|
| `SEVERE_WEATHER` | HIGH | Severe weather warning on driver's route ahead | Proactive |
| `ROAD_CLOSURE` | HIGH | Road closed on planned route | Proactive |
| `TRAFFIC_DELAY` | MEDIUM | Unexpected traffic adding > 30min to segment | Reactive |

#### Category 6: System

| Alert Type | Priority | Trigger | Proactive? |
|-----------|----------|---------|------------|
| `INTEGRATION_SYNC_FAILURE` | HIGH | External integration failed to sync | Reactive |
| `ROUTE_PLAN_FAILED` | MEDIUM | Route planning engine returned an error | Reactive |

### 3.2 Alert Priority Levels

| Priority | Visual | Sound | SLA (Acknowledge) | Escalation |
|----------|--------|-------|-------------------|------------|
| **CRITICAL** | Red background, pulsing icon | Alarm sound (configurable) | 5 minutes | Auto-escalate to supervisor after SLA |
| **HIGH** | Orange background, solid icon | Alert tone (configurable) | 15 minutes | Auto-escalate after SLA |
| **MEDIUM** | Yellow background, solid icon | None (optional) | 60 minutes | Auto-escalate after SLA |
| **LOW** | Blue background, subtle icon | None | Best effort | No escalation |

### 3.3 Alert Lifecycle

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         â”‚
                    â–¼                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NEW  â”‚â”€â”€â”€â–¶â”‚    ACTIVE     â”‚â”€â”€â”€â–¶â”‚  ACKNOWLEDGED  â”‚â”€â”€â”€â–¶â”‚ RESOLVED â”‚
â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                                       â–²
                    â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  SNOOZED â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   (returns to ACTIVE
                                    after snooze period)
```

**States:**
- **ACTIVE** â€” New alert, awaiting dispatcher attention
- **ACKNOWLEDGED** â€” Dispatcher is aware and working on it (prevents duplicate effort)
- **SNOOZED** â€” Temporarily muted, will reactivate after snooze period (15min, 30min, 1hr, custom)
- **RESOLVED** â€” Issue addressed, alert closed (with resolution notes)
- **AUTO_RESOLVED** â€” System detected the condition cleared (e.g., driver started moving again)

### 3.4 Alert Grouping

To prevent alert fatigue, related alerts are grouped:

**Grouping Rules:**
1. **Same type + same driver within 15 minutes** â†’ Group as update (don't create new alert)
2. **Same type + multiple drivers** â†’ Smart group: "3 drivers approaching HOS limit" with drill-down
3. **Same route + multiple types** â†’ Route group: "Route #1234 has 3 active alerts" with breakdown
4. **Cascading alerts** â†’ Link as parent-child (e.g., ROUTE_DELAY caused by TRAFFIC_DELAY)

**Group Display:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš  3 Drivers Approaching HOS Limit              â”‚
â”‚ Drivers: J. Smith (45min), M. Chen (38min),     â”‚
â”‚          R. Patel (52min)                        â”‚
â”‚ [Expand] [Acknowledge All] [View Details]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Notification System Design

### 4.1 Notification Taxonomy

#### Category: System Events

| Type | Recipient(s) | Channels | Example |
|------|-------------|----------|---------|
| `ROUTE_PLANNED` | Dispatcher who created it | In-App | "Route #1234 planned successfully" |
| `ROUTE_UPDATED` | Assigned dispatcher + driver | In-App, Push | "Route #1234 updated: new fuel stop added" |
| `ROUTE_COMPLETED` | Dispatcher | In-App | "Driver Smith completed Route #1234" |
| `INTEGRATION_SYNCED` | Admin | In-App | "Truckbase TMS sync completed: 12 loads imported" |
| `INTEGRATION_CONNECTED` | Admin | In-App, Email | "Samsara ELD integration connected successfully" |

#### Category: Team & Admin Events

| Type | Recipient(s) | Channels | Example |
|------|-------------|----------|---------|
| `USER_INVITED` | Invitee | Email | "You've been invited to join Acme Trucking on SALLY" |
| `USER_JOINED` | Admin, Owner | In-App | "John Smith accepted the invitation and joined" |
| `ROLE_CHANGED` | Affected user | In-App, Email | "Your role has been updated to Dispatcher" |
| `DRIVER_ACTIVATED` | Admin | In-App | "Driver Mike Johnson has been activated" |
| `SETTINGS_UPDATED` | Admin, Owner | In-App | "Operations settings updated by Jane Doe" |
| `TENANT_APPROVED` | Owner | Email, In-App | "Your SALLY account has been approved" |
| `TENANT_SUSPENDED` | Owner | Email | "Your account has been suspended" |

#### Category: Operations

| Type | Recipient(s) | Channels | Example |
|------|-------------|----------|---------|
| `LOAD_ASSIGNED` | Driver, Dispatcher | In-App, Push | "Load #5678 assigned to you" |
| `LOAD_STATUS_CHANGED` | Dispatcher | In-App | "Load #5678 status: In Transit â†’ Delivered" |
| `SCHEDULE_CHANGED` | Driver | In-App, Push, SMS | "Your schedule for tomorrow has been updated" |
| `REST_REMINDER` | Driver | In-App, Push | "Recommended rest stop in 30 minutes at Exit 45" |

#### Category: Driver-Dispatcher Communications

| Type | Recipient(s) | Channels | Example |
|------|-------------|----------|---------|
| `DISPATCH_MESSAGE` | Driver | In-App, Push, SMS | "Message from dispatch: Call office when you arrive" |
| `DRIVER_CHECK_IN` | Dispatcher | In-App | "Driver Smith checked in at Phoenix terminal" |
| `ACKNOWLEDGMENT_REQUEST` | Driver | In-App, Push | "Please confirm you received the updated route" |
| `ACKNOWLEDGMENT_RECEIVED` | Dispatcher | In-App | "Driver Smith acknowledged route update" |

### 4.2 Notification Lifecycle

```
UNREAD â†’ READ â†’ DISMISSED (optional)
```

- **UNREAD** â€” New, shown with visual indicator (dot, bold, count)
- **READ** â€” User has seen it (clicked or opened)
- **DISMISSED** â€” User explicitly removed from inbox

**Bulk Actions:**
- Mark all as read
- Dismiss all read notifications
- Filter by category

### 4.3 Delivery Channels

| Channel | Use Case | Technology | Availability |
|---------|----------|------------|--------------|
| **In-App** | All notifications | SSE push + REST fallback | Phase 1 |
| **Email** | Important events, digests | Resend/SMTP (existing) | Phase 1 |
| **Push** | Mobile-critical (driver route updates) | Web Push API (PWA) | Phase 2 |
| **SMS** | Critical driver communications | Twilio/similar | Phase 2 |

---

## 5. Alert Generation Engine

### 5.1 Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MONITORING SERVICE                     â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ HOS Monitor  â”‚  â”‚Route Monitor â”‚  â”‚Vehicle Monitorâ”‚  â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚
â”‚  â”‚ - Violation  â”‚  â”‚ - Delay      â”‚  â”‚ - Fuel level â”‚  â”‚
â”‚  â”‚ - Approach   â”‚  â”‚ - Dock time  â”‚  â”‚ - Maintenanceâ”‚  â”‚
â”‚  â”‚ - Break req  â”‚  â”‚ - Missed apt â”‚  â”‚              â”‚  â”‚
â”‚  â”‚ - Cycle      â”‚  â”‚ - Deviation  â”‚  â”‚              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                 â”‚                 â”‚           â”‚
â”‚         â–¼                 â–¼                 â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              TRIGGER EVALUATOR                    â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  1. Evaluate conditions against thresholds        â”‚   â”‚
â”‚  â”‚  2. Check deduplication window                    â”‚   â”‚
â”‚  â”‚  3. Apply grouping rules                          â”‚   â”‚
â”‚  â”‚  4. Determine priority                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                â”‚
â”‚                         â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              ALERT GENERATION ENGINE              â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  1. Create/update Alert record                    â”‚   â”‚
â”‚  â”‚  2. Apply grouping (parent-child, smart group)    â”‚   â”‚
â”‚  â”‚  3. Check escalation rules                        â”‚   â”‚
â”‚  â”‚  4. Emit event to Notification Delivery           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NOTIFICATION DELIVERY ENGINE                 â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  SSE     â”‚  â”‚  Email   â”‚  â”‚ Push â”‚  â”‚   SMS    â”‚    â”‚
â”‚  â”‚ (real-   â”‚  â”‚ (Resend/ â”‚  â”‚ (Web â”‚  â”‚ (Twilio) â”‚    â”‚
â”‚  â”‚  time)   â”‚  â”‚  SMTP)   â”‚  â”‚ Push)â”‚  â”‚          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  Channel routing based on:                               â”‚
â”‚  - Alert priority â†’ tenant escalation policy             â”‚
â”‚  - User preferences â†’ personal channel config            â”‚
â”‚  - Notification type â†’ system defaults                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Monitoring Loop

```python
# Pseudocode for the monitoring service
async def monitoring_loop():
    while True:
        active_routes = await get_active_routes()

        for route in active_routes:
            # Gather current state
            driver = await get_driver_state(route.driver_id)
            vehicle = await get_vehicle_state(route.vehicle_id)
            hos = await get_hos_data(route.driver_id)
            weather = await get_weather(route.current_position)
            traffic = await get_traffic(route.remaining_segments)

            # Evaluate all triggers
            triggers = []
            triggers += evaluate_hos_triggers(hos, route)
            triggers += evaluate_route_triggers(route, traffic)
            triggers += evaluate_driver_triggers(driver, route)
            triggers += evaluate_vehicle_triggers(vehicle, route)
            triggers += evaluate_external_triggers(weather, traffic, route)

            # Process triggers through alert engine
            for trigger in triggers:
                await alert_engine.process_trigger(trigger, route)

        await sleep(MONITORING_INTERVAL)  # 60 seconds per route
```

### 5.3 Deduplication

Prevents the same condition from generating repeated alerts:

```
Deduplication Key = {alert_type}:{driver_id}:{route_id}
Deduplication Window = configurable per alert type (default: 15 minutes)

IF existing active alert with same dedup key AND within window:
    â†’ UPDATE existing alert (refresh timestamp, update details)
    â†’ DO NOT create new alert
ELSE:
    â†’ CREATE new alert
```

### 5.4 Auto-Resolution

Some alerts should auto-resolve when the condition clears:

| Alert Type | Auto-Resolve Condition |
|-----------|----------------------|
| `DRIVER_NOT_MOVING` | Driver starts moving again |
| `FUEL_LOW` | Driver refuels |
| `OFF_ROUTE` | Driver returns to planned route |
| `TRAFFIC_DELAY` | Traffic clears, ETA returns to acceptable |

Auto-resolved alerts are marked with `status: AUTO_RESOLVED` and include the resolution timestamp and reason.

---

## 6. Dispatcher UX â€” Alerts Command Center

### 6.1 Page: `/dispatcher/overview` (Replaces Current Command Center)

The Command Center becomes an **operational dashboard with alerts as the centerpiece**. This is where dispatchers spend most of their day.

### 6.2 Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HEADER                                                    ðŸ”” ðŸ‘¤  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        â”‚ Command Center                                          â”‚
â”‚        â”‚                                                         â”‚
â”‚ SIDE   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ BAR    â”‚ â”‚ Active  â”‚ Critical â”‚ Avg Resp â”‚ Resolved â”‚           â”‚
â”‚        â”‚ â”‚ Alerts  â”‚ Alerts   â”‚ Time     â”‚ Today    â”‚           â”‚
â”‚        â”‚ â”‚   12    â”‚    2     â”‚  8 min   â”‚   34     â”‚           â”‚
â”‚        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚        â”‚ â”‚ ALERTS TABLE                                      â”‚   â”‚
â”‚        â”‚ â”‚                                                   â”‚   â”‚
â”‚        â”‚ â”‚ [All] [Critical] [High] [Medium] [Low]            â”‚   â”‚
â”‚        â”‚ â”‚ [Filter: Driver â–¼] [Type â–¼] [Status â–¼] [Search]  â”‚   â”‚
â”‚        â”‚ â”‚                                                   â”‚   â”‚
â”‚        â”‚ â”‚ â”Œâ”€ â— HOS_VIOLATION Â· CRITICAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚        â”‚ â”‚ â”‚ Driver: John Smith Â· Route #1234              â”‚ â”‚   â”‚
â”‚        â”‚ â”‚ â”‚ 11-hour drive limit exceeded by 12 min        â”‚ â”‚   â”‚
â”‚        â”‚ â”‚ â”‚ 2 min ago Â· [Acknowledge] [Snooze] [Details]  â”‚ â”‚   â”‚
â”‚        â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚        â”‚ â”‚                                                   â”‚   â”‚
â”‚        â”‚ â”‚ â”Œâ”€ â–² 3 Drivers Approaching HOS Limit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚        â”‚ â”‚ â”‚ J.Smith (45m), M.Chen (38m), R.Patel (52m)    â”‚ â”‚   â”‚
â”‚        â”‚ â”‚ â”‚ 5 min ago Â· [Expand] [Ack All] [Details]      â”‚ â”‚   â”‚
â”‚        â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚        â”‚ â”‚                                                   â”‚   â”‚
â”‚        â”‚ â”‚ ... more alerts ...                               â”‚   â”‚
â”‚        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚        â”‚ â”‚ RECENT ACTIVITY    â”‚ FLEET SNAPSHOT               â”‚   â”‚
â”‚        â”‚ â”‚                    â”‚                              â”‚   â”‚
â”‚        â”‚ â”‚ Timeline of        â”‚ Active drivers: 24          â”‚   â”‚
â”‚        â”‚ â”‚ recent events      â”‚ En route: 18                â”‚   â”‚
â”‚        â”‚ â”‚ and resolutions    â”‚ At dock: 4                  â”‚   â”‚
â”‚        â”‚ â”‚                    â”‚ Resting: 2                  â”‚   â”‚
â”‚        â”‚ â”‚                    â”‚ Available: 8                â”‚   â”‚
â”‚        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚        â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 Summary Statistics Bar

Four stat cards at the top providing at-a-glance operational health:

| Stat | Source | Visual |
|------|--------|--------|
| **Active Alerts** | Count of alerts with status `active` | Number + trend arrow |
| **Critical Alerts** | Count of critical priority active alerts | Red badge if > 0 |
| **Avg Response Time** | Average time from creation to acknowledgment (today) | Duration + trend |
| **Resolved Today** | Count of alerts resolved in last 24hrs | Number + trend arrow |

### 6.4 Alerts Table

**Columns:**
1. **Priority indicator** â€” Color-coded dot/bar (red/orange/yellow/blue)
2. **Alert Type + Title** â€” e.g., "HOS_VIOLATION: 11-hour drive limit exceeded"
3. **Driver** â€” Driver name with avatar
4. **Route** â€” Route ID (clickable link)
5. **Status** â€” Active / Acknowledged / Snoozed badge
6. **Time** â€” Relative timestamp ("2 min ago")
7. **Actions** â€” Acknowledge, Snooze, Resolve, Details

**Filtering:**
- Priority tabs: All, Critical, High, Medium, Low
- Dropdown filters: Driver, Alert Type, Status, Date Range
- Search: Free-text search across alert title and message

**Sorting:**
- Default: Priority (Critical first), then newest first
- Sortable columns: Priority, Time, Driver, Type

**Grouped Alerts:**
- Smart groups shown as expandable rows
- Group header shows count and summary
- Expand to see individual alerts within group
- "Acknowledge All" and "Resolve All" actions on group

### 6.5 Alert Detail View

Clicking an alert opens a detail panel (slide-in from right or modal):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â— HOS VIOLATION                        CRITICAL â”‚
â”‚                                                  â”‚
â”‚ Driver: John Smith                               â”‚
â”‚ Route: #1234 (Phoenix â†’ Las Vegas)               â”‚
â”‚ Vehicle: Truck #567                              â”‚
â”‚                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                  â”‚
â”‚ 11-hour drive time limit exceeded by 12 minutes. â”‚
â”‚ Driver has been on duty since 4:00 AM MST.       â”‚
â”‚                                                  â”‚
â”‚ Recommended Action:                              â”‚
â”‚ Instruct driver to pull over at nearest safe     â”‚
â”‚ location for mandatory 10-hour rest break.       â”‚
â”‚ Next rest stop: Exit 45, 12 miles ahead.         â”‚
â”‚                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                  â”‚
â”‚ Timeline:                                        â”‚
â”‚ â€¢ 2:12 PM â€” Alert created (auto-generated)       â”‚
â”‚ â€¢ 2:14 PM â€” Acknowledged by Jane Doe             â”‚
â”‚ â€¢ 2:15 PM â€” Note: "Called driver, pulling over"  â”‚
â”‚ â€¢ 2:45 PM â€” Resolved by Jane Doe                 â”‚
â”‚                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                  â”‚
â”‚ Related Alerts:                                  â”‚
â”‚ â€¢ HOS_APPROACHING_LIMIT (1:45 PM) â€” Resolved    â”‚
â”‚ â€¢ ROUTE_DELAY (2:10 PM) â€” Active                 â”‚
â”‚                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                  â”‚
â”‚ [Add Note] [Snooze â–¼] [Resolve] [Send to Driver] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.6 Actions

| Action | Description | Availability |
|--------|-------------|--------------|
| **Acknowledge** | "I see this and I'm on it" â€” prevents duplicate effort | Active alerts only |
| **Snooze** | Temporarily mute (15min, 30min, 1hr, custom) â€” returns to active after period | Active and acknowledged alerts |
| **Resolve** | Mark as handled â€” with optional resolution notes | Acknowledged alerts |
| **Add Note** | Free-text note attached to alert timeline | Any non-resolved alert |
| **Send to Driver** | Send a notification/message to the driver about this alert | Any alert with a driver |
| **View Route** | Navigate to the route detail page | Alerts with route_id |
| **View Driver** | Navigate to driver profile | Alerts with driver_id |

### 6.7 Real-Time Behavior

- **SSE connection** keeps alerts table live-updated
- New alerts appear at top with subtle entry animation
- Priority changes update in place
- Auto-resolved alerts show brief "resolved" animation then move to resolved section
- Sound notification for Critical alerts (configurable, can be disabled)
- Browser tab title changes: "âš  (2) Command Center â€” SALLY" when critical alerts exist

### 6.8 Secondary Sections

Below the alerts table:

**Recent Activity Timeline:**
- Shows recent events: alerts resolved, routes completed, drivers checked in
- Provides context for the operational tempo
- Auto-updates via SSE

**Fleet Snapshot:**
- Current driver statuses (active, en route, at dock, resting, available)
- Quick visual of fleet health
- Links to fleet management page

---

## 7. Driver UX â€” Mobile-First PWA

### 7.1 Design Principles

1. **Mobile-first** â€” Designed for phone screens, usable while parked
2. **Glanceable** â€” Key info visible without scrolling
3. **Non-punitive tone** â€” "Recommendation" not "Violation warning"
4. **Minimal interaction** â€” Large touch targets, simple actions
5. **Context-aware** â€” Show what matters NOW (next stop, HOS remaining, active alerts)

### 7.2 Driver Notification Types

| Type | Delivery | Priority | Example |
|------|----------|----------|---------|
| **Route Assignment** | In-App + Push | High | "New route assigned: Phoenix â†’ Las Vegas" |
| **Route Update** | In-App + Push | High | "Your route has been updated: new fuel stop added at Exit 45" |
| **HOS Warning** | In-App + Push | High | "Recommended rest in 45 minutes based on your remaining drive time" |
| **Rest Reminder** | In-App + Push | Medium | "Rest stop coming up in 12 miles at Exit 45" |
| **Dispatch Message** | In-App + Push + SMS | Varies | "Message from dispatch: Call office when you arrive" |
| **Schedule Change** | In-App + Push + SMS | High | "Tomorrow's schedule updated â€” check your routes" |
| **Acknowledgment Request** | In-App + Push | High | "Please confirm you received the route update" |
| **Fuel Stop Reminder** | In-App | Medium | "Planned fuel stop in 30 miles â€” best price at Pilot Exit 67" |
| **Weather Advisory** | In-App + Push | Medium | "Winter storm warning on your route ahead â€” exercise caution" |
| **Arrival Confirmation** | In-App | Low | "You've arrived at Stop #3. Check in when ready." |

### 7.3 Driver Notification Center

Located in the driver's sidebar/header â€” a simple, clean inbox:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Notifications                    [Mark All Read] â”‚
â”‚                                                  â”‚
â”‚ TODAY                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ ðŸš› Route Updated             2 min ago   â”‚     â”‚
â”‚ â”‚ Fuel stop added at Exit 45.              â”‚     â”‚
â”‚ â”‚ [View Route] [Acknowledge]               â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ ðŸ’¬ Dispatch Message           15 min ago  â”‚     â”‚
â”‚ â”‚ Call office when you arrive in Phoenix.  â”‚     â”‚
â”‚ â”‚                                          â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ â° Rest Reminder              1 hr ago    â”‚     â”‚
â”‚ â”‚ Recommended rest stop in 30 miles.       â”‚     â”‚
â”‚ â”‚                                [Dimmed â€” Read] â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                  â”‚
â”‚ YESTERDAY                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ ðŸš› Route Assigned             Yesterday   â”‚     â”‚
â”‚ â”‚ Route #1234: Phoenix â†’ Las Vegas         â”‚     â”‚
â”‚ â”‚                                [Dimmed â€” Read] â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.4 PWA Push Notifications

**Technology:** Web Push API with Service Worker

**Push Notification Format:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SALLY                                â”‚
â”‚ Route Updated                        â”‚
â”‚ Fuel stop added at Exit 45.          â”‚
â”‚ Tap to view route details.           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Push Notification Rules:**
- Only sent for notifications where user has enabled push channel
- Respect device quiet hours (configurable)
- Group multiple pushes into summary if > 3 in 5 minutes
- Deep link into relevant page when tapped

### 7.5 SMS Fallback

For critical communications when driver may not have the app open:

**SMS Triggers:**
- Dispatch messages marked as urgent
- Schedule changes affecting next 12 hours
- Missed acknowledgment requests (after 15 min no response to push)

**SMS Format:**
```
SALLY: Message from dispatch â€” Call office when you arrive in Phoenix.
Open app for details: sally.app/m/abc123
```

---

## 8. Notification Center UX

### 8.1 Location & Access

- **Bell icon** in the header (separate from alert indicators)
- Click opens a **dropdown panel** (quick view)
- "View All" link opens **full notification page** at `/notifications`

### 8.2 Notification Bell

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ðŸ””(3)  â”‚  â† Badge shows unread count
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- Badge shows unread count (max "99+")
- No pulsing/alarm animations (that's for alerts)
- Subtle dot indicator when new notifications arrive

### 8.3 Quick View Dropdown

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Notifications                [Mark All] â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                         â”‚
â”‚ â— Route #1234 planned successfully      â”‚
â”‚   2 minutes ago                         â”‚
â”‚                                         â”‚
â”‚ â— John Smith accepted the invitation    â”‚
â”‚   15 minutes ago                        â”‚
â”‚                                         â”‚
â”‚ â—‹ Truckbase sync: 12 loads imported     â”‚
â”‚   1 hour ago                            â”‚
â”‚                                         â”‚
â”‚ â—‹ Operations settings updated by Jane   â”‚
â”‚   3 hours ago                           â”‚
â”‚                                         â”‚
â”‚              [View All Notifications]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â— = unread    â—‹ = read
```

### 8.4 Full Notifications Page (`/notifications`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Notifications                                                â”‚
â”‚                                                              â”‚
â”‚ [All] [System] [Team] [Operations] [Messages]     [Search]  â”‚
â”‚                                                    [Filter â–¼]â”‚
â”‚                                                              â”‚
â”‚ TODAY                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â— ðŸš› Route #1234 planned successfully      2 min ago    â”‚ â”‚
â”‚ â”‚   Phoenix â†’ Las Vegas Â· 3 stops Â· Driver: John Smith     â”‚ â”‚
â”‚ â”‚                                     [View Route] [Dismiss]â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ â— ðŸ‘¤ John Smith accepted invitation         15 min ago   â”‚ â”‚
â”‚ â”‚   Role: Dispatcher Â· Team: Operations                    â”‚ â”‚
â”‚ â”‚                                     [View User] [Dismiss] â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ â—‹ ðŸ”„ Truckbase TMS sync completed          1 hour ago   â”‚ â”‚
â”‚ â”‚   12 loads imported, 3 updated, 0 errors                 â”‚ â”‚
â”‚ â”‚                                [View Loads] [Dismiss]     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚ YESTERDAY                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â—‹ âš™ï¸ Operations settings updated            Yesterday    â”‚ â”‚
â”‚ â”‚   Updated by Jane Doe: Alert thresholds changed          â”‚ â”‚
â”‚ â”‚                               [View Settings] [Dismiss]  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚                      [Load More]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.5 Notification Actions

| Action | Description |
|--------|-------------|
| **Click/Tap** | Navigate to the relevant page (route, user, settings) + mark as read |
| **Mark as Read** | Remove unread indicator without navigating |
| **Dismiss** | Remove from notification list |
| **Mark All Read** | Clear all unread indicators |
| **Filter** | By category, read/unread status, date range |

---

## 9. Real-Time Delivery Infrastructure

### 9.1 Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND SERVICES                      â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Alert       â”‚â”€â”€â”€â”€â–¶â”‚   EVENT BUS (Redis Pub/Sub)  â”‚  â”‚
â”‚  â”‚  Generation  â”‚     â”‚                              â”‚  â”‚
â”‚  â”‚  Engine      â”‚     â”‚  Channels:                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â€¢ alerts:{tenant_id}        â”‚  â”‚
â”‚                       â”‚  â€¢ notifications:{user_id}   â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â€¢ messages:{conversation_id}â”‚  â”‚
â”‚  â”‚  Notificationâ”‚â”€â”€â”€â”€â–¶â”‚                              â”‚  â”‚
â”‚  â”‚  Service     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚                       â”‚
â”‚                                  â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           DELIVERY ENGINE                         â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ SSE Server â”‚ â”‚ Push/SMS   â”‚ â”‚ Email Serviceâ”‚  â”‚   â”‚
â”‚  â”‚  â”‚ (real-time â”‚ â”‚ (async     â”‚ â”‚ (async       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  to browserâ”‚ â”‚  delivery) â”‚ â”‚  delivery)   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  clients)  â”‚ â”‚            â”‚ â”‚              â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                    â”‚               â”‚
          â–¼                    â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Browser  â”‚        â”‚ Mobile   â”‚    â”‚ Email    â”‚
    â”‚ (SSE)    â”‚        â”‚ (Push)   â”‚    â”‚ Inbox    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 SSE (Server-Sent Events)

**Purpose:** Real-time push of alerts and notifications to browser clients

**Endpoint:** `GET /api/v1/sse/stream`

**Authentication:** JWT token in query param or header

**Event Types:**
```
event: alert:new
data: {"id": "ALT-001", "type": "HOS_VIOLATION", "priority": "critical", ...}

event: alert:updated
data: {"id": "ALT-001", "status": "acknowledged", ...}

event: alert:resolved
data: {"id": "ALT-001", "status": "resolved", ...}

event: notification:new
data: {"id": "NTF-001", "type": "ROUTE_PLANNED", "title": "...", ...}

event: alert:count
data: {"active": 12, "critical": 2}

event: notification:count
data: {"unread": 3}
```

**Client Implementation:**
```typescript
// SSE client hook
const useSSEStream = () => {
  useEffect(() => {
    const eventSource = new EventSource('/api/v1/sse/stream?token=...');

    eventSource.addEventListener('alert:new', (e) => {
      const alert = JSON.parse(e.data);
      queryClient.invalidateQueries(['alerts']);
      // Show toast for critical alerts
      if (alert.priority === 'critical') {
        playAlertSound();
        showToast(alert);
      }
    });

    eventSource.addEventListener('notification:new', (e) => {
      const notification = JSON.parse(e.data);
      queryClient.invalidateQueries(['notifications']);
    });

    // SSE auto-reconnects on failure
    eventSource.onerror = () => {
      // Fallback to polling if SSE unavailable
      startPollingFallback();
    };

    return () => eventSource.close();
  }, []);
};
```

**SSE Benefits:**
- Auto-reconnection built into the browser API
- Simpler than WebSocket for one-way push
- Works through HTTP proxies and load balancers
- Lower overhead than WebSocket for server-push only

### 9.3 WebSocket (Driver-Dispatcher Messaging)

**Purpose:** Bidirectional messaging between drivers and dispatchers

**Endpoint:** `ws://api/v1/ws`

**Use Cases:**
- Driver-dispatcher chat messages
- Real-time acknowledgment flow
- Driver check-in/status updates

**Implementation:** Socket.io or native WebSocket with NestJS Gateway

```typescript
// WebSocket Gateway (NestJS)
@WebSocketGateway({ namespace: '/messages' })
export class MessagesGateway {

  @SubscribeMessage('send_message')
  async handleMessage(client: Socket, payload: MessagePayload) {
    // Save message to database
    const message = await this.messagesService.create(payload);
    // Broadcast to recipient
    this.server.to(`user:${payload.recipientId}`).emit('new_message', message);
    // Also create notification
    await this.notificationService.create({
      type: 'DISPATCH_MESSAGE',
      recipientId: payload.recipientId,
      // ...
    });
  }

  @SubscribeMessage('acknowledge')
  async handleAcknowledge(client: Socket, payload: AckPayload) {
    // Record acknowledgment
    // Notify dispatcher
  }
}
```

### 9.4 Fallback Strategy

```
Primary:    SSE for alerts/notifications push
            WebSocket for messaging

Fallback:   Polling every 30s (current behavior)
            Used when SSE connection fails

Degradation: Polling â†’ SSE reconnect attempt every 60s
             WebSocket â†’ HTTP POST fallback for messages
```

---

## 10. Settings Architecture â€” Layered System

### 10.1 Design Philosophy

Two layers with clear boundaries:

| Layer | Scope | Set By | Purpose | Override? |
|-------|-------|--------|---------|-----------|
| **Operations Settings** | Tenant-wide | Admin, Owner | Organizational policy | Cannot override mandatory settings |
| **User Preferences** | Personal | Each user | Personal customization | Within boundaries set by Operations |

### 10.2 Operations Settings (Tenant-Wide)

**Location:** `/settings/operations` â†’ "Alerts & Notifications" section

#### Alert Configuration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Alert Configuration                                          â”‚
â”‚                                                              â”‚
â”‚ Enabled Alert Types                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â˜‘ HOS Compliance Alerts        [Mandatory - Cannot Disable]â”‚
â”‚ â”‚   â˜‘ HOS Violation              Threshold: N/A (any)      â”‚ â”‚
â”‚ â”‚   â˜‘ HOS Approaching Limit      Threshold: [1 hr â–¼]       â”‚ â”‚
â”‚ â”‚   â˜‘ Break Required              Threshold: [7 hr â–¼]       â”‚ â”‚
â”‚ â”‚   â˜‘ Cycle Approaching Limit     Threshold: [5 hr â–¼]       â”‚ â”‚
â”‚ â”‚                                                            â”‚ â”‚
â”‚ â”‚ â˜‘ Route Progress Alerts                                    â”‚ â”‚
â”‚ â”‚   â˜‘ Missed Appointment          [Mandatory - Cannot Disable]â”‚
â”‚ â”‚   â˜‘ Appointment at Risk         Threshold: [30 min â–¼]     â”‚ â”‚
â”‚ â”‚   â˜‘ Dock Time Exceeded          Threshold: [1 hr â–¼]       â”‚ â”‚
â”‚ â”‚   â˜ Route Delay                 Threshold: [30 min â–¼]     â”‚ â”‚
â”‚ â”‚   â˜ Stop Sequence Deviation                                â”‚ â”‚
â”‚ â”‚                                                            â”‚ â”‚
â”‚ â”‚ â˜‘ Driver Behavior Alerts                                   â”‚ â”‚
â”‚ â”‚   â˜‘ Driver Not Moving           Threshold: [2 hr â–¼]       â”‚ â”‚
â”‚ â”‚   â˜ Unexpected Stop             Threshold: [15 min â–¼]     â”‚ â”‚
â”‚ â”‚   â˜ Off Route                                              â”‚ â”‚
â”‚ â”‚                                                            â”‚ â”‚
â”‚ â”‚ â˜‘ Vehicle Alerts                                           â”‚ â”‚
â”‚ â”‚   â˜‘ Fuel Low                    Threshold: [20% â–¼]        â”‚ â”‚
â”‚ â”‚   â˜ Fuel Stop Missed                                       â”‚ â”‚
â”‚ â”‚   â˜ Maintenance Due                                        â”‚ â”‚
â”‚ â”‚                                                            â”‚ â”‚
â”‚ â”‚ â˜ External Condition Alerts                                â”‚ â”‚
â”‚ â”‚   â˜ Severe Weather                                         â”‚ â”‚
â”‚ â”‚   â˜ Road Closure                                           â”‚ â”‚
â”‚ â”‚   â˜ Traffic Delay               Threshold: [30 min â–¼]     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚ Escalation Policy                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Critical alerts unacknowledged after [5 min â–¼]           â”‚ â”‚
â”‚ â”‚   â†’ Escalate to: [Supervisors â–¼]                         â”‚ â”‚
â”‚ â”‚   â†’ Channel: [Email + SMS â–¼]                             â”‚ â”‚
â”‚ â”‚                                                          â”‚ â”‚
â”‚ â”‚ High alerts unacknowledged after [15 min â–¼]              â”‚ â”‚
â”‚ â”‚   â†’ Escalate to: [All Dispatchers â–¼]                     â”‚ â”‚
â”‚ â”‚   â†’ Channel: [Email â–¼]                                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚ Alert Grouping                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â˜‘ Group same-type alerts per driver (window: [15 min â–¼]) â”‚ â”‚
â”‚ â”‚ â˜‘ Smart group same-type across drivers                   â”‚ â”‚
â”‚ â”‚ â˜‘ Link cascading alerts (parent-child)                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚                                            [Save Changes]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Notification Defaults

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Default Notification Channels (Per Priority)                 â”‚
â”‚                                                              â”‚
â”‚                  In-App   Email    Push     SMS               â”‚
â”‚ Critical         â˜‘        â˜‘        â˜‘        â˜‘               â”‚
â”‚ High             â˜‘        â˜‘        â˜‘        â˜               â”‚
â”‚ Medium           â˜‘        â˜        â˜        â˜               â”‚
â”‚ Low              â˜‘        â˜        â˜        â˜               â”‚
â”‚                                                              â”‚
â”‚ â„¹ Users can customize their personal delivery preferences    â”‚
â”‚   but cannot disable mandatory alert types.                  â”‚
â”‚                                                              â”‚
â”‚                                            [Save Changes]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.3 User Preferences (Personal)

**Location:** `/settings/preferences` â†’ "Notifications" tab

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ My Notification Preferences                                  â”‚
â”‚                                                              â”‚
â”‚ Alert Delivery Channels                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ How do you want to receive alerts?                       â”‚ â”‚
â”‚ â”‚                                                          â”‚ â”‚
â”‚ â”‚                        In-App   Email    Push     SMS    â”‚ â”‚
â”‚ â”‚ Critical Alerts        â˜‘ ðŸ”’     â˜‘ ðŸ”’     â˜‘        â˜‘     â”‚ â”‚
â”‚ â”‚ High Alerts            â˜‘ ðŸ”’     â˜‘        â˜‘        â˜     â”‚ â”‚
â”‚ â”‚ Medium Alerts          â˜‘        â˜        â˜        â˜     â”‚ â”‚
â”‚ â”‚ Low Alerts             â˜‘        â˜        â˜        â˜     â”‚ â”‚
â”‚ â”‚                                                          â”‚ â”‚
â”‚ â”‚ ðŸ”’ = Required by your organization                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚ Notification Delivery Channels                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                        In-App   Email    Push            â”‚ â”‚
â”‚ â”‚ Route Updates          â˜‘        â˜        â˜‘              â”‚ â”‚
â”‚ â”‚ Team Updates           â˜‘        â˜‘        â˜              â”‚ â”‚
â”‚ â”‚ Integration Events     â˜‘        â˜        â˜              â”‚ â”‚
â”‚ â”‚ Dispatch Messages      â˜‘        â˜        â˜‘              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚ Sound & Display                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â˜‘ Play sound for Critical alerts                        â”‚ â”‚
â”‚ â”‚ â˜‘ Play sound for High alerts                            â”‚ â”‚
â”‚ â”‚ â˜ Play sound for Medium/Low alerts                      â”‚ â”‚
â”‚ â”‚                                                          â”‚ â”‚
â”‚ â”‚ â˜‘ Show browser desktop notifications                    â”‚ â”‚
â”‚ â”‚ â˜‘ Flash browser tab for Critical alerts                 â”‚ â”‚
â”‚ â”‚                                                          â”‚ â”‚
â”‚ â”‚ Snooze Duration Default: [15 min â–¼]                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚ Digest Preferences                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â˜ Send daily digest email (summary of the day's events) â”‚ â”‚
â”‚ â”‚   Time: [6:00 AM â–¼]                                     â”‚ â”‚
â”‚ â”‚                                                          â”‚ â”‚
â”‚ â”‚ â˜ Send shift summary email (end of shift recap)         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚                                            [Save Changes]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.4 How Layers Interact

```
Admin sets in Operations Settings:
  â†’ HOS_VIOLATION alerts: ENABLED, MANDATORY
  â†’ Default channels: In-App + Email + Push + SMS

User sets in Preferences:
  â†’ Cannot disable HOS_VIOLATION (mandatory, shows ðŸ”’)
  â†’ Can add/remove Push and SMS for non-mandatory alerts
  â†’ Can toggle sounds, browser notifications
  â†’ Can set snooze defaults

Effective Config = Operations (base) + User (overrides within bounds)
```

**Rules:**
1. If Operations marks an alert type as MANDATORY â†’ User cannot disable it
2. If Operations sets a channel as required for a priority â†’ User sees ðŸ”’, cannot turn off
3. User can always ADD channels beyond the Operations default
4. User can only REMOVE channels that aren't marked as required
5. If Operations disables an alert type â†’ It disappears from User Preferences entirely

---

## 11. Alert Fatigue Prevention

### 11.1 Smart Grouping

**Same Type + Same Driver:**
```
Instead of:
  âš  HOS Approaching Limit â€” John Smith (2:00 PM)
  âš  HOS Approaching Limit â€” John Smith (2:15 PM)
  âš  HOS Approaching Limit â€” John Smith (2:30 PM)

Show:
  âš  HOS Approaching Limit â€” John Smith (updated 2:30 PM)
  "Drive time remaining: 38 min (was 52 min at first alert)"
```

**Same Type + Multiple Drivers:**
```
Instead of:
  âš  HOS Approaching Limit â€” John Smith
  âš  HOS Approaching Limit â€” Mary Chen
  âš  HOS Approaching Limit â€” Raj Patel

Show:
  âš  3 Drivers Approaching HOS Limit
  J. Smith (38 min), M. Chen (45 min), R. Patel (52 min)
  [Expand] [Acknowledge All]
```

**Cascading Alerts:**
```
Instead of:
  âš  TRAFFIC_DELAY â€” Route #1234
  âš  ROUTE_DELAY â€” Route #1234
  âš  APPOINTMENT_AT_RISK â€” Route #1234

Show:
  âš  Route #1234: Traffic Impact (3 related alerts)
  Root cause: Traffic delay on I-10 (+45 min)
  Impact: Route delayed, appointment at risk
  [Expand] [View Route]
```

### 11.2 Configurable Thresholds

Every threshold-based alert type has configurable values:

| Setting | Default | Range | Location |
|---------|---------|-------|----------|
| HOS approaching limit | 1 hour | 30min â€” 3hrs | Operations Settings |
| Dock time exceeded | 1 hour | 30min â€” 4hrs | Operations Settings |
| Route delay threshold | 30 min | 15min â€” 2hrs | Operations Settings |
| Driver not moving | 2 hours | 30min â€” 4hrs | Operations Settings |
| Fuel low threshold | 20% | 10% â€” 30% | Operations Settings |
| Dedup window | 15 min | 5min â€” 1hr | Operations Settings |

### 11.3 Escalation System

Prevents important alerts from being missed while avoiding constant noise:

```
Alert Created (CRITICAL)
    â”œâ”€â”€ Immediately: Push to Command Center (SSE)
    â”œâ”€â”€ 0 min: Sound notification (if enabled)
    â”œâ”€â”€ 5 min (unacknowledged):
    â”‚   â”œâ”€â”€ Escalate to supervisor via email + SMS
    â”‚   â””â”€â”€ Visual escalation in UI (pulsing, moved to top)
    â”œâ”€â”€ 15 min (still unacknowledged):
    â”‚   â”œâ”€â”€ Escalate to all dispatchers
    â”‚   â””â”€â”€ Mark as "overdue" in Command Center
    â””â”€â”€ 30 min (still unacknowledged):
        â”œâ”€â”€ Escalate to admin/owner
        â””â”€â”€ Log compliance concern
```

### 11.4 Snooze Mechanism

Dispatchers can snooze non-critical alerts:

- **Available durations:** 15 min, 30 min, 1 hr, 2 hr, End of Shift, Custom
- **Snoozed alerts** â†’ moved to "Snoozed" section, not in main table
- **Auto-unsnooze** â†’ Returns to active after period expires
- **Cannot snooze:** CRITICAL alerts and mandatory alerts (can acknowledge but not snooze)
- **Snooze with note:** Optional note explaining why ("Waiting for driver callback")

### 11.5 Quiet Hours & Shift Awareness

- **Quiet hours** configurable per user (e.g., no sounds 10 PM â€” 6 AM)
- **Shift-based routing:** Alerts route to on-duty dispatcher, not off-duty
- **Handoff:** End-of-shift summary of unresolved alerts for next dispatcher

---

## 12. Data Models

### 12.1 Alert Model (Enhanced)

```prisma
model Alert {
  id                    Int           @id @default(autoincrement())
  alertId               String        @unique @default(cuid()) @map("alert_id")
  tenantId              Int           @map("tenant_id")

  // Context
  driverId              String?       @map("driver_id")
  routePlanId           String?       @map("route_plan_id")
  vehicleId             String?       @map("vehicle_id")

  // Classification
  alertType             String        @map("alert_type")        // HOS_VIOLATION, etc.
  category              String        @map("category")          // hos, route, driver, vehicle, external, system
  priority              String        @map("priority")          // critical, high, medium, low

  // Content
  title                 String
  message               String        @db.Text
  recommendedAction     String?       @map("recommended_action") @db.Text
  metadata              Json?                                    // Additional context data

  // Lifecycle
  status                String        @default("active")        // active, acknowledged, snoozed, resolved, auto_resolved
  acknowledgedAt        DateTime?     @map("acknowledged_at")
  acknowledgedBy        String?       @map("acknowledged_by")
  snoozedUntil          DateTime?     @map("snoozed_until")
  resolvedAt            DateTime?     @map("resolved_at")
  resolvedBy            String?       @map("resolved_by")
  resolutionNotes       String?       @map("resolution_notes") @db.Text
  autoResolved          Boolean       @default(false) @map("auto_resolved")
  autoResolveReason     String?       @map("auto_resolve_reason")

  // Grouping
  parentAlertId         String?       @map("parent_alert_id")   // For cascading/grouped alerts
  groupKey              String?       @map("group_key")         // Dedup/grouping key

  // Escalation
  escalationLevel       Int           @default(0) @map("escalation_level")
  escalatedAt           DateTime?     @map("escalated_at")

  // Deduplication
  dedupKey              String        @map("dedup_key")         // {type}:{driver}:{route}

  // Timestamps
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  // Relations
  tenant                Tenant        @relation(fields: [tenantId], references: [id])
  notes                 AlertNote[]
  parentAlert           Alert?        @relation("AlertGroup", fields: [parentAlertId], references: [alertId])
  childAlerts           Alert[]       @relation("AlertGroup")

  @@index([tenantId, status, priority, createdAt])
  @@index([dedupKey, status])
  @@index([driverId, status])
  @@index([routePlanId, status])
  @@index([parentAlertId])
  @@map("alerts")
}

model AlertNote {
  id            Int       @id @default(autoincrement())
  noteId        String    @unique @default(cuid()) @map("note_id")
  alertId       String    @map("alert_id")
  authorId      String    @map("author_id")
  authorName    String    @map("author_name")
  content       String    @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")

  alert         Alert     @relation(fields: [alertId], references: [alertId])

  @@index([alertId, createdAt])
  @@map("alert_notes")
}
```

### 12.2 Notification Model (Enhanced)

```prisma
enum NotificationType {
  // System Events
  ROUTE_PLANNED
  ROUTE_UPDATED
  ROUTE_COMPLETED
  INTEGRATION_SYNCED
  INTEGRATION_CONNECTED
  INTEGRATION_FAILED

  // Team Events
  USER_INVITED
  USER_JOINED
  ROLE_CHANGED
  DRIVER_ACTIVATED
  SETTINGS_UPDATED

  // Operations
  LOAD_ASSIGNED
  LOAD_STATUS_CHANGED
  SCHEDULE_CHANGED
  REST_REMINDER

  // Communications
  DISPATCH_MESSAGE
  DRIVER_CHECK_IN
  ACKNOWLEDGMENT_REQUEST
  ACKNOWLEDGMENT_RECEIVED

  // Existing (tenant lifecycle)
  TENANT_REGISTRATION_CONFIRMATION
  TENANT_APPROVED
  TENANT_REJECTED
  USER_INVITATION
}

enum NotificationCategory {
  SYSTEM
  TEAM
  OPERATIONS
  COMMUNICATIONS
}

model Notification {
  id              Int                   @id @default(autoincrement())
  notificationId  String                @unique @default(cuid()) @map("notification_id")

  // Targeting
  recipientId     Int                   @map("recipient_id")    // User ID
  tenantId        Int?                  @map("tenant_id")

  // Classification
  type            NotificationType
  category        NotificationCategory

  // Content
  title           String
  message         String                @db.Text
  actionUrl       String?               @map("action_url")      // Deep link to relevant page
  actionLabel     String?               @map("action_label")    // "View Route", "View User"
  iconType        String?               @map("icon_type")       // route, user, integration, message
  metadata        Json?

  // Lifecycle
  status          String                @default("unread")       // unread, read, dismissed
  readAt          DateTime?             @map("read_at")
  dismissedAt     DateTime?             @map("dismissed_at")

  // Delivery tracking
  deliveryChannels Json?                @map("delivery_channels") // {"in_app": "sent", "email": "sent", "push": "failed"}

  // Timestamps
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")

  // Relations
  recipient       User                  @relation(fields: [recipientId], references: [id])

  @@index([recipientId, status, createdAt])
  @@index([tenantId, type, createdAt])
  @@map("notifications")
}
```

### 12.3 Alert Configuration Model

```prisma
model AlertConfiguration {
  id              Int       @id @default(autoincrement())
  tenantId        Int       @unique @map("tenant_id")

  // Alert type configuration (JSON with enabled/disabled + thresholds)
  alertTypes      Json      @map("alert_types")
  // Example: {
  //   "HOS_VIOLATION": { "enabled": true, "mandatory": true },
  //   "HOS_APPROACHING_LIMIT": { "enabled": true, "mandatory": false, "threshold_minutes": 60 },
  //   "DRIVER_NOT_MOVING": { "enabled": true, "mandatory": false, "threshold_minutes": 120 },
  //   ...
  // }

  // Escalation configuration
  escalationPolicy Json    @map("escalation_policy")
  // Example: {
  //   "critical": { "acknowledge_sla_minutes": 5, "escalate_to": "supervisors", "channels": ["email", "sms"] },
  //   "high": { "acknowledge_sla_minutes": 15, "escalate_to": "all_dispatchers", "channels": ["email"] },
  //   ...
  // }

  // Grouping configuration
  groupingConfig  Json      @map("grouping_config")
  // Example: {
  //   "dedup_window_minutes": 15,
  //   "group_same_type_per_driver": true,
  //   "smart_group_across_drivers": true,
  //   "link_cascading": true
  // }

  // Default notification channels per priority
  defaultChannels Json      @map("default_channels")
  // Example: {
  //   "critical": { "in_app": true, "email": true, "push": true, "sms": true },
  //   "high": { "in_app": true, "email": true, "push": true, "sms": false },
  //   ...
  // }

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  tenant          Tenant    @relation(fields: [tenantId], references: [id])

  @@map("alert_configurations")
}
```

### 12.4 User Notification Preferences Model

```prisma
model UserNotificationPreferences {
  id              Int       @id @default(autoincrement())
  userId          Int       @unique @map("user_id")
  tenantId        Int       @map("tenant_id")

  // Alert delivery channel preferences
  alertChannels   Json      @map("alert_channels")
  // Example: {
  //   "critical": { "in_app": true, "email": true, "push": true, "sms": true },
  //   "high": { "in_app": true, "email": true, "push": false, "sms": false },
  //   "medium": { "in_app": true, "email": false, "push": false, "sms": false },
  //   "low": { "in_app": true, "email": false, "push": false, "sms": false }
  // }

  // Notification delivery channel preferences
  notificationChannels Json @map("notification_channels")
  // Example: {
  //   "SYSTEM": { "in_app": true, "email": false, "push": true },
  //   "TEAM": { "in_app": true, "email": true, "push": false },
  //   "OPERATIONS": { "in_app": true, "email": false, "push": true },
  //   "COMMUNICATIONS": { "in_app": true, "email": false, "push": true }
  // }

  // Sound & display
  soundEnabled    Json      @map("sound_enabled")
  // Example: { "critical": true, "high": true, "medium": false, "low": false }

  browserNotifications Boolean @default(true) @map("browser_notifications")
  flashTabOnCritical   Boolean @default(true) @map("flash_tab_on_critical")

  // Snooze default
  defaultSnoozeDuration Int   @default(15) @map("default_snooze_duration") // minutes

  // Digest
  dailyDigestEnabled  Boolean @default(false) @map("daily_digest_enabled")
  dailyDigestTime     String? @map("daily_digest_time") // "06:00"
  shiftSummaryEnabled Boolean @default(false) @map("shift_summary_enabled")

  // Push notification token (for PWA)
  pushSubscription    Json?   @map("push_subscription")

  // SMS
  smsNumber           String? @map("sms_number")
  smsEnabled          Boolean @default(false) @map("sms_enabled")

  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user                User     @relation(fields: [userId], references: [id])

  @@map("user_notification_preferences")
}
```

---

## 13. API Design

### 13.1 Alert Endpoints

```
# List alerts (with filtering, pagination, grouping)
GET /api/v1/alerts
  ?status=active,acknowledged
  &priority=critical,high
  &driver_id=DRV-001
  &category=hos,route
  &grouped=true              # Return grouped alerts
  &page=1&limit=50
  &sort=priority,createdAt

# Get alert detail
GET /api/v1/alerts/:alert_id
  â†’ Includes: notes, child alerts, related alerts

# Acknowledge alert
POST /api/v1/alerts/:alert_id/acknowledge
  Body: { acknowledged_by?: string }

# Snooze alert
POST /api/v1/alerts/:alert_id/snooze
  Body: { duration_minutes: 15, note?: string }

# Resolve alert
POST /api/v1/alerts/:alert_id/resolve
  Body: { resolution_notes?: string, resolved_by?: string }

# Add note to alert
POST /api/v1/alerts/:alert_id/notes
  Body: { content: string }

# Bulk acknowledge
POST /api/v1/alerts/bulk/acknowledge
  Body: { alert_ids: string[], acknowledged_by?: string }

# Bulk resolve
POST /api/v1/alerts/bulk/resolve
  Body: { alert_ids: string[], resolution_notes?: string }

# Alert statistics
GET /api/v1/alerts/stats
  â†’ { active: 12, critical: 2, avg_response_time: "8m", resolved_today: 34 }

# Alert history (for analytics)
GET /api/v1/alerts/history
  ?from=2026-02-01&to=2026-02-06
  &driver_id=DRV-001
```

### 13.2 Notification Endpoints

```
# List notifications for current user
GET /api/v1/notifications
  ?status=unread
  &category=system,team
  &page=1&limit=20

# Get unread count
GET /api/v1/notifications/count
  â†’ { unread: 3, by_category: { system: 1, team: 1, operations: 1 } }

# Mark as read
POST /api/v1/notifications/:notification_id/read

# Dismiss notification
POST /api/v1/notifications/:notification_id/dismiss

# Mark all as read
POST /api/v1/notifications/mark-all-read
  Body: { category?: string }  # Optional: only mark specific category

# Dismiss all read
POST /api/v1/notifications/dismiss-all-read
```

### 13.3 SSE Endpoint

```
# Real-time event stream
GET /api/v1/sse/stream
  Headers: Authorization: Bearer <jwt>

  # Server sends:
  event: alert:new
  data: { ...alert }

  event: alert:updated
  data: { id: "...", status: "acknowledged" }

  event: alert:resolved
  data: { id: "...", status: "resolved" }

  event: notification:new
  data: { ...notification }

  event: heartbeat
  data: { timestamp: "..." }
```

### 13.4 Configuration Endpoints

```
# Get tenant alert configuration
GET /api/v1/settings/alerts

# Update tenant alert configuration (admin/owner only)
PUT /api/v1/settings/alerts
  Body: { alertTypes: {...}, escalationPolicy: {...}, ... }

# Get user notification preferences
GET /api/v1/preferences/notifications

# Update user notification preferences
PUT /api/v1/preferences/notifications
  Body: { alertChannels: {...}, soundEnabled: {...}, ... }

# Register push subscription (PWA)
POST /api/v1/preferences/push-subscription
  Body: { subscription: PushSubscription }
```

---

## 14. Implementation Phases

### Phase 1: Foundation (Weeks 1-3)

**Goal:** Get real alerts flowing and visible to dispatchers

**Backend:**
- [ ] Enhance Alert model (add grouping, escalation, dedup fields)
- [ ] Create Notification model
- [ ] Create AlertConfiguration model
- [ ] Create UserNotificationPreferences model
- [ ] Build Alert Generation Engine (connect to monitoring triggers)
- [ ] Implement deduplication logic
- [ ] Implement basic alert statistics endpoint
- [ ] Implement notification CRUD endpoints

**Frontend:**
- [ ] Build Alerts Command Center page (replace Command Center)
  - [ ] Summary stats bar
  - [ ] Alerts table with filtering and sorting
  - [ ] Alert detail panel
  - [ ] Acknowledge, Resolve actions
- [ ] Build Notification Center
  - [ ] Bell icon with unread count
  - [ ] Quick-view dropdown
  - [ ] Mark as read, dismiss actions
- [ ] Replace polling with SSE for alerts (with polling fallback)

**Settings:**
- [ ] Add "Alerts & Notifications" section to Operations Settings
  - [ ] Alert type enable/disable with thresholds
- [ ] Add "Notifications" tab to User Preferences
  - [ ] Basic channel preferences

### Phase 2: Intelligence (Weeks 4-6)

**Goal:** Smart grouping, escalation, and multi-channel delivery

**Backend:**
- [ ] Implement smart alert grouping
- [ ] Implement cascading alert linking
- [ ] Build escalation engine (SLA monitoring, auto-escalation)
- [ ] Implement auto-resolution logic
- [ ] Implement snooze mechanism
- [ ] Add alert notes functionality
- [ ] Implement bulk actions (acknowledge all, resolve all)

**Frontend:**
- [ ] Grouped alert display in Command Center
- [ ] Snooze UI with duration options
- [ ] Alert notes and timeline
- [ ] Escalation indicators
- [ ] Sound notifications for Critical/High alerts
- [ ] Browser tab title update for critical alerts
- [ ] Full notifications page (`/notifications`)

**Settings:**
- [ ] Escalation policy configuration in Operations Settings
- [ ] Alert grouping configuration
- [ ] Sound and display preferences in User Preferences
- [ ] Digest preferences

### Phase 3: Multi-Channel & Driver Experience (Weeks 7-10)

**Goal:** Reach drivers via push and SMS, full driver notification UX

**Backend:**
- [ ] Implement Web Push API integration (VAPID keys, service worker)
- [ ] Implement SMS delivery (Twilio or similar)
- [ ] Build notification delivery engine (channel routing based on preferences)
- [ ] Implement WebSocket gateway for driver-dispatcher messaging
- [ ] Build push subscription management

**Frontend:**
- [ ] PWA Service Worker for push notifications
- [ ] Push notification opt-in flow for drivers
- [ ] Driver notification center (mobile-optimized)
- [ ] Driver acknowledgment flow
- [ ] Enhanced dispatch messages page (connected to messaging system)

**Settings:**
- [ ] Push notification preferences
- [ ] SMS number configuration
- [ ] Mandatory alert channel enforcement (ðŸ”’ indicators)

### Phase 4: Analytics & Polish (Weeks 11-12)

**Goal:** Operational insights and production hardening

**Backend:**
- [ ] Alert history and analytics endpoints
- [ ] Daily digest email generation
- [ ] Shift summary email generation
- [ ] Performance optimization (query tuning, caching)
- [ ] Alert generation for all 20 alert types
- [ ] Stress testing and load testing

**Frontend:**
- [ ] Alert analytics dashboard (response times, volume trends, resolution rates)
- [ ] Historical alert view with date range filtering
- [ ] Driver performance insights (based on alerts)
- [ ] Shift handoff view (unresolved alerts for next shift)
- [ ] Comprehensive E2E testing

---

## Appendix A: Competitive Insights

Based on analysis of Samsara, Motive, Geotab, and Omnitracs:

1. **Alert fatigue is the #1 user complaint** across all platforms
2. **Proactive alerts** (predicting issues before they happen) deliver 30% better on-time performance
3. **SSE is emerging** as the preferred real-time technology for fleet dashboards
4. **Smart grouping** is a differentiator â€” most platforms don't do it well
5. **Two-audience design** (dispatcher vs driver) is critical â€” same information, different presentation
6. **Configurable thresholds** prevent false positives, the main driver of alert fatigue

## Appendix B: Integration Points

| System | Alert/Notification | Direction |
|--------|-------------------|-----------|
| Route Planning Engine | Triggers alerts when plan constraints violated | â†’ Alert Engine |
| Monitoring Service | Continuous evaluation of 14 trigger types | â†’ Alert Engine |
| TMS Integration (Truckbase) | Load assignment notifications | â†’ Notification Service |
| ELD Integration (Samsara) | HOS data for compliance alerts | â†’ Alert Engine |
| Weather API | Weather alerts on active routes | â†’ Alert Engine |
| Email Service (existing) | Notification delivery channel | â† Delivery Engine |
| User Management | Team notifications (invite, join, role change) | â†’ Notification Service |

## Appendix C: Metrics to Track

| Metric | Target | Description |
|--------|--------|-------------|
| Alert-to-Acknowledge Time | < 5 min (Critical), < 15 min (High) | How fast dispatchers respond |
| Alert-to-Resolve Time | < 30 min (Critical), < 2 hr (High) | How fast issues are fixed |
| False Positive Rate | < 10% | Alerts that were dismissed without action |
| Alert Volume per Driver per Day | < 5 | Indicator of alert fatigue risk |
| Notification Read Rate | > 80% | Are users engaging with notifications |
| Push Delivery Success Rate | > 95% | Technical health of push system |
| SSE Connection Uptime | > 99.5% | Real-time delivery reliability |

---

*This design document represents the full vision for SALLY's alerts and notifications system. Implementation should follow the phased approach in Section 14, building a solid foundation first and layering intelligence and multi-channel delivery on top.*
