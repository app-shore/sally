@startuml Deployment_Diagram
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Deployment.puml

LAYOUT_WITH_LEGEND()

title Deployment diagram for SALLY (Development Environment)

Deployment_Node(dev_machine, "Developer Machine", "macOS/Linux/Windows") {
    Deployment_Node(docker, "Docker Desktop", "Docker Engine") {
        Deployment_Node(network, "sally-network", "Docker Bridge Network") {

            Deployment_Node(postgres_container, "sally-postgres", "Docker Container") {
                ContainerDb(postgres, "PostgreSQL 16", "Alpine Linux", "Primary data store with async connection pooling")
                Deployment_Node(pg_volume, "postgres_data", "Docker Volume") {
                    Container(pg_data, "Database Files", "PostgreSQL Data", "Persistent storage for all tables")
                }
            }

            Deployment_Node(redis_container, "sally-redis", "Docker Container") {
                ContainerDb(redis, "Redis 7", "Alpine Linux", "Cache and session store")
                Deployment_Node(redis_volume, "redis_data", "Docker Volume") {
                    Container(redis_data, "Cache Files", "Redis Data", "Persistent cache data")
                }
            }

            Deployment_Node(backend_container, "sally-backend", "Docker Container") {
                Container(fastapi, "FastAPI Application", "Python 3.11, UV", "REST API with HOS, Optimization, and Prediction engines")
                Container(uvicorn, "Uvicorn Server", "ASGI Server", "Async web server with hot-reload")
            }

            Deployment_Node(frontend_container, "sally-frontend", "Docker Container") {
                Container(nextjs, "Next.js Application", "Node 20, TypeScript", "Operations dashboard with SSR")
                Container(node_server, "Node.js Server", "Development Server", "Hot-reload dev server")
            }
        }
    }

    Deployment_Node(browser, "Web Browser", "Chrome/Firefox/Safari") {
        Container(ui, "Dashboard UI", "React 18", "Interactive operations dashboard")
    }
}

Rel(ui, nextjs, "HTTP Requests", "Port 3000")
Rel(nextjs, fastapi, "API Calls", "Port 8000, HTTPS/JSON")
Rel(fastapi, postgres, "Database Queries", "Port 5432, PostgreSQL Protocol")
Rel(fastapi, redis, "Cache Operations", "Port 6379, Redis Protocol")

Rel(postgres, pg_data, "Persists to")
Rel(redis, redis_data, "Persists to")

note right of network
  **Network Configuration:**
  - All containers on same bridge network
  - Internal DNS resolution
  - Healthchecks enabled
  - Auto-restart on failure
end note

note right of postgres
  **Database:**
  - User: rest_os_user
  - Database: rest_os
  - 5 tables: drivers, vehicles,
    routes, events, recommendations
  - Async connections via AsyncPG
end note

note right of redis
  **Cache:**
  - HOS validation results
  - Prediction results
  - Session data (future)
end note

note right of fastapi
  **Backend Ports:**
  - 8000: API endpoint
  - Healthcheck: /health
  - Docs: /docs (Swagger)
  - Metrics: /metrics (future)
end note

note right of nextjs
  **Frontend Ports:**
  - 3000: Web UI
  - Hot-reload enabled
  - API proxy configured
end note

@enduml
