generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// AUTHENTICATION & MULTI-TENANCY MODELS
// ============================================================================

enum UserRole {
  DISPATCHER
  DRIVER
  ADMIN
  OWNER           // Tenant owner - created during registration, cannot be deleted
  SUPER_ADMIN
}

enum TenantStatus {
  PENDING_APPROVAL
  ACTIVE
  REJECTED
  SUSPENDED
}

enum FleetSize {
  SIZE_1_10      @map("1-10")
  SIZE_11_50     @map("11-50")
  SIZE_51_100    @map("51-100")
  SIZE_101_500   @map("101-500")
  SIZE_500_PLUS  @map("500+")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  CANCELLED
  EXPIRED
}

model Tenant {
  id                    Int          @id @default(autoincrement())
  tenantId              String       @unique @map("tenant_id") @db.VarChar(50)
  companyName           String       @map("company_name") @db.VarChar(255)
  subdomain             String?      @unique @db.VarChar(100)
  contactEmail          String?      @map("contact_email") @db.VarChar(255)
  contactPhone          String?      @map("contact_phone") @db.VarChar(50)

  // Registration fields
  status                TenantStatus @default(PENDING_APPROVAL)
  dotNumber             String?      @map("dot_number") @db.VarChar(8)
  fleetSize             FleetSize?   @map("fleet_size")

  // Approval tracking
  approvedAt            DateTime?    @map("approved_at") @db.Timestamptz
  approvedBy            String?      @map("approved_by") @db.VarChar(100)
  rejectedAt            DateTime?    @map("rejected_at") @db.Timestamptz
  rejectionReason       String?      @map("rejection_reason")

  // Suspension tracking
  suspendedAt           DateTime?    @map("suspended_at") @db.Timestamptz
  suspendedBy           String?      @map("suspended_by") @db.VarChar(100)
  suspensionReason      String?      @map("suspension_reason")

  // Reactivation tracking
  reactivatedAt         DateTime?    @map("reactivated_at") @db.Timestamptz
  reactivatedBy         String?      @map("reactivated_by") @db.VarChar(100)

  // Onboarding tracking
  onboardingCompletedAt DateTime?    @map("onboarding_completed_at") @db.Timestamptz
  onboardingProgress    Json?        @map("onboarding_progress")

  isActive              Boolean      @default(false) @map("is_active")
  createdAt             DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime     @updatedAt @map("updated_at") @db.Timestamptz

  users                 User[]
  drivers               Driver[]
  vehicles              Vehicle[]
  routePlans            RoutePlan[]
  alerts                Alert[]
  integrationConfigs    IntegrationConfig[]
  fleetOperationsSettings FleetOperationsSettings?
  invitations           UserInvitation[]
  notifications         Notification[]
  alertConfiguration    AlertConfiguration?
  loads                 Load[]
  shiftNotes            ShiftNote[]
  conversations         Conversation[]

  @@index([tenantId])
  @@index([subdomain])
  @@index([status])
  @@index([dotNumber])
  @@map("tenants")
}

model User {
  id                Int              @id @default(autoincrement())
  userId            String           @unique @map("user_id") @db.VarChar(50)

  tenant            Tenant?          @relation(fields: [tenantId], references: [id])
  tenantId          Int?             @map("tenant_id")

  email             String           @db.VarChar(255)
  passwordHash      String?          @map("password_hash") @db.VarChar(255)
  firstName         String           @map("first_name") @db.VarChar(100)
  lastName          String           @map("last_name") @db.VarChar(100)
  role              UserRole

  // Firebase integration
  firebaseUid       String?          @unique @map("firebase_uid") @db.VarChar(128)
  emailVerified     Boolean          @default(false) @map("email_verified")

  // Driver link (optional, only for DRIVER role)
  driver            Driver?          @relation(fields: [driverId], references: [id])
  driverId          Int?             @unique @map("driver_id")

  // Status tracking
  isActive          Boolean          @default(true) @map("is_active")
  lastLoginAt       DateTime?        @map("last_login_at") @db.Timestamptz
  passwordChangedAt DateTime?        @map("password_changed_at") @db.Timestamptz

  // Soft delete
  deletedAt         DateTime?        @map("deleted_at") @db.Timestamptz
  deletedBy         Int?             @map("deleted_by")
  deletedByUser     User?            @relation("DeletedBy", fields: [deletedBy], references: [id])
  deletedUsers      User[]           @relation("DeletedBy")
  deletionReason    String?          @map("deletion_reason")

  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime         @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  refreshTokens     RefreshToken[]
  apiKeys           ApiKey[]
  preferences       UserPreferences?
  driverPreferences DriverPreferences?
  superAdminPreferences SuperAdminPreferences?
  invitationsSent   UserInvitation[] @relation("InvitedBy")
  invitationsAccepted UserInvitation[] @relation("AcceptedBy")
  driversActivated  Driver[]         @relation("ActivatedBy")
  driversDeactivated Driver[]        @relation("DeactivatedBy")
  driversReactivated Driver[]        @relation("ReactivatedBy")
  notifications     Notification[]
  pushSubscriptions PushSubscription[]
  shiftNotes        ShiftNote[]
  conversations     Conversation[]

  @@index([tenantId])
  @@index([email])
  @@index([firebaseUid])
  @@index([role])
  @@index([isActive])
  @@index([deletedAt])
  @@map("users")
}

model SuperAdminPreferences {
  id                      Int      @id @default(autoincrement())
  userId                  Int      @unique @map("user_id")
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  notifyNewTenants        Boolean  @default(true) @map("notify_new_tenants")
  notifyStatusChanges     Boolean  @default(true) @map("notify_status_changes")
  notificationFrequency   String   @default("immediate") @map("notification_frequency") @db.VarChar(20)

  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt               DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@index([userId])
  @@map("super_admin_preferences")
}

model RefreshToken {
  id                    Int          @id @default(autoincrement())
  tokenId               String       @unique @map("token_id") @db.VarChar(50)
  userId                Int          @map("user_id")
  token                 String       @db.VarChar(500)
  expiresAt             DateTime     @map("expires_at") @db.Timestamptz
  isRevoked             Boolean      @default(false) @map("is_revoked")
  createdAt             DateTime     @default(now()) @map("created_at") @db.Timestamptz
  revokedAt             DateTime?    @map("revoked_at") @db.Timestamptz

  user                  User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model ApiKey {
  id            String    @id @default(uuid())
  key           String    @unique @db.VarChar(64)
  name          String    @db.VarChar(255)
  userId        Int       @map("user_id")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Usage tracking
  lastUsedAt    DateTime? @map("last_used_at") @db.Timestamptz
  requestCount  Int       @default(0) @map("request_count")

  // Rate limiting
  rateLimit     Int       @default(1000) @map("rate_limit")

  // Status
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  expiresAt     DateTime? @map("expires_at") @db.Timestamptz
  revokedAt     DateTime? @map("revoked_at") @db.Timestamptz

  @@index([userId])
  @@index([key])
  @@map("api_keys")
}

model UserInvitation {
  id                    Int           @id @default(autoincrement())
  invitationId          String        @unique @default(uuid()) @map("invitation_id")

  tenant                Tenant        @relation(fields: [tenantId], references: [id])
  tenantId              Int           @map("tenant_id")

  email                 String        @db.VarChar(255)
  firstName             String        @map("first_name") @db.VarChar(100)
  lastName              String        @map("last_name") @db.VarChar(100)
  role                  UserRole

  // Optional driver link (for DRIVER role invitations)
  driverId              Int?          @map("driver_id")
  driver                Driver?       @relation(fields: [driverId], references: [id])

  token                 String        @unique @db.VarChar(255)
  expiresAt             DateTime      @map("expires_at") @db.Timestamptz

  invitedBy             Int           @map("invited_by")
  invitedByUser         User          @relation("InvitedBy", fields: [invitedBy], references: [id])

  status                InvitationStatus @default(PENDING)
  acceptedAt            DateTime?     @map("accepted_at") @db.Timestamptz
  acceptedByUserId      Int?          @map("accepted_by_user_id")
  acceptedByUser        User?         @relation("AcceptedBy", fields: [acceptedByUserId], references: [id])

  cancelledAt           DateTime?     @map("cancelled_at") @db.Timestamptz
  cancellationReason    String?       @map("cancellation_reason")

  createdAt             DateTime      @default(now()) @map("created_at") @db.Timestamptz

  notifications         Notification[]

  @@index([tenantId])
  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@index([status])
  @@index([driverId])
  @@map("user_invitations")
}

// ============================================================================
// EXISTING MODELS (UPDATED FOR MULTI-TENANCY)
// ============================================================================

enum DriverStatus {
  PENDING_ACTIVATION
  ACTIVE
  INACTIVE
  SUSPENDED
  REMOVED_FROM_SOURCE
}

enum SyncStatus {
  SYNCED
  REMOVED
  SYNC_ERROR
  MANUAL_ENTRY
}

model Driver {
  id                    Int           @id @default(autoincrement())
  driverId              String        @unique @map("driver_id") @db.VarChar(50)

  tenant                Tenant        @relation(fields: [tenantId], references: [id])
  tenantId              Int           @map("tenant_id")

  name                  String        @db.VarChar(255)
  licenseNumber         String?       @map("license_number") @db.VarChar(50)
  licenseState          String?       @map("license_state") @db.VarChar(2)
  phone                 String?       @db.VarChar(20)
  email                 String?       @db.VarChar(255)

  // Status management
  status                DriverStatus  @default(PENDING_ACTIVATION)
  isActive              Boolean       @default(true) @map("is_active")

  // Activation tracking
  activatedAt           DateTime?     @map("activated_at") @db.Timestamptz
  activatedBy           Int?          @map("activated_by")
  activatedByUser       User?         @relation("ActivatedBy", fields: [activatedBy], references: [id])

  // Deactivation tracking
  deactivatedAt         DateTime?     @map("deactivated_at") @db.Timestamptz
  deactivatedBy         Int?          @map("deactivated_by")
  deactivatedByUser     User?         @relation("DeactivatedBy", fields: [deactivatedBy], references: [id])
  deactivationReason    String?       @map("deactivation_reason")

  // Reactivation tracking
  reactivatedAt         DateTime?     @map("reactivated_at") @db.Timestamptz
  reactivatedBy         Int?          @map("reactivated_by")
  reactivatedByUser     User?         @relation("ReactivatedBy", fields: [reactivatedBy], references: [id])

  // External sync tracking
  externalDriverId      String?       @map("external_driver_id") @db.VarChar(100)
  externalSource        String?       @map("external_source") @db.VarChar(50)
  lastSyncedAt          DateTime?     @map("last_synced_at") @db.Timestamptz
  syncStatus            SyncStatus?   @map("sync_status")

  // HOS cache
  hosData               Json?         @map("hos_data")
  hosDataSyncedAt       DateTime?     @map("hos_data_synced_at") @db.Timestamptz
  hosDataSource         String?       @map("hos_data_source") @db.VarChar(50)

  // Manual override
  hosManualOverride     Json?         @map("hos_manual_override")
  hosOverrideBy         Int?          @map("hos_override_by")
  hosOverrideAt         DateTime?     @map("hos_override_at") @db.Timestamptz
  hosOverrideReason     String?       @map("hos_override_reason")

  // ELD HOS Metadata (JSONB - vendor agnostic)
  eldMetadata           Json?         @map("eld_metadata")

  // Structured HOS fields (engine reads directly)
  currentHoursDriven      Float     @default(0) @map("current_hours_driven")
  currentOnDutyTime       Float     @default(0) @map("current_on_duty_time")
  currentHoursSinceBreak  Float     @default(0) @map("current_hours_since_break")
  cycleHoursUsed          Float     @default(0) @map("cycle_hours_used")
  cycleDaysData           Json?     @map("cycle_days_data")
  lastRestartAt           DateTime? @map("last_restart_at") @db.Timestamptz
  homeTerminalTimezone    String    @default("America/New_York") @map("home_terminal_timezone") @db.VarChar(50)

  createdAt             DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime      @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user                  User?
  routePlans            RoutePlan[]
  driverPreferences     DriverPreferences?
  invitations           UserInvitation[]

  @@unique([driverId, tenantId])
  @@index([tenantId])
  @@index([externalDriverId])
  @@index([status])
  @@index([syncStatus])
  @@index([isActive])
  @@index([phone])
  @@index([licenseNumber, licenseState])
  @@map("drivers")
}

model Vehicle {
  id                    Int          @id @default(autoincrement())
  vehicleId             String       @map("vehicle_id") @db.VarChar(50)
  unitNumber            String       @db.VarChar(50) @map("unit_number")
  fuelCapacityGallons   Float?       @map("fuel_capacity_gallons")
  currentFuelGallons    Float?       @map("current_fuel_gallons")
  mpg                   Float?
  isActive              Boolean      @default(true) @map("is_active")
  createdAt             DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime     @updatedAt @map("updated_at") @db.Timestamptz

  // External system linkage (matching Driver model pattern)
  externalVehicleId     String?      @map("external_vehicle_id") @db.VarChar(100)
  externalSource        String?      @map("external_source") @db.VarChar(50)
  lastSyncedAt          DateTime?    @map("last_synced_at") @db.Timestamptz

  // TMS Fields (source of truth for operational data)
  make                  String?      @db.VarChar(50)
  model                 String?      @db.VarChar(50)
  year                  Int?
  vin                   String?      @db.VarChar(50)
  licensePlate          String?      @map("license_plate") @db.VarChar(20)

  // ELD Telematics Metadata (JSONB - vendor agnostic)
  eldTelematicsMetadata Json?        @map("eld_telematics_metadata")

  hasSleeperBerth         Boolean   @default(true) @map("has_sleeper_berth")
  grossWeightLbs          Float?    @map("gross_weight_lbs")

  tenant                Tenant       @relation(fields: [tenantId], references: [id])
  tenantId              Int          @map("tenant_id")

  routePlans            RoutePlan[]

  @@unique([vehicleId, tenantId])
  @@unique([externalVehicleId, tenantId])
  @@index([tenantId])
  @@index([vin])
  @@index([licensePlate])
  @@map("vehicles")
}

model RoutePlan {
  id                    Int              @id @default(autoincrement())
  planId                String           @unique @map("plan_id") @db.VarChar(50)
  driverId              Int              @map("driver_id")
  vehicleId             Int              @map("vehicle_id")
  planVersion           Int              @default(1) @map("plan_version")
  isActive              Boolean          @default(false) @map("is_active")
  status                String           @default("draft") @db.VarChar(50)
  optimizationPriority  String           @default("minimize_time") @map("optimization_priority") @db.VarChar(50)
  totalDistanceMiles    Float            @default(0.0) @map("total_distance_miles")
  totalDriveTimeHours   Float            @default(0.0) @map("total_drive_time_hours")
  totalOnDutyTimeHours  Float            @default(0.0) @map("total_on_duty_time_hours")
  totalCostEstimate     Float            @default(0.0) @map("total_cost_estimate")
  isFeasible            Boolean          @default(true) @map("is_feasible")
  feasibilityIssues     Json?            @map("feasibility_issues")
  complianceReport      Json?            @map("compliance_report")
  activatedAt           DateTime?        @map("activated_at") @db.Timestamptz

  // Timing
  departureTime           DateTime?  @map("departure_time") @db.Timestamptz
  estimatedArrival        DateTime?  @map("estimated_arrival") @db.Timestamptz
  completedAt             DateTime?  @map("completed_at") @db.Timestamptz
  cancelledAt             DateTime?  @map("cancelled_at") @db.Timestamptz

  // Enhanced summary
  totalTripTimeHours      Float      @default(0) @map("total_trip_time_hours")
  totalDrivingDays        Int        @default(1) @map("total_driving_days")

  // Dispatcher input
  dispatcherParams        Json?      @map("dispatcher_params")

  // Daily breakdown
  dailyBreakdown          Json?      @map("daily_breakdown")

  createdAt             DateTime         @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime         @updatedAt @map("updated_at") @db.Timestamptz

  tenant                Tenant           @relation(fields: [tenantId], references: [id])
  tenantId              Int              @map("tenant_id")

  driver                Driver           @relation(fields: [driverId], references: [id])
  vehicle               Vehicle          @relation(fields: [vehicleId], references: [id])
  segments              RouteSegment[]
  updates               RoutePlanUpdate[]
  loads                 RoutePlanLoad[]

  @@index([driverId])
  @@index([isActive])
  @@index([tenantId])
  @@map("route_plans")
}

model RouteSegment {
  id                    Int          @id @default(autoincrement())
  segmentId             String       @unique @map("segment_id") @db.VarChar(50)
  planId                Int          @map("plan_id")
  sequenceOrder         Int          @map("sequence_order")
  fromLocation          String?      @map("from_location") @db.VarChar(200)
  toLocation            String?      @map("to_location") @db.VarChar(200)
  segmentType           String       @map("segment_type") @db.VarChar(20)
  distanceMiles         Float?       @map("distance_miles")
  driveTimeHours        Float?       @map("drive_time_hours")
  restType              String?      @map("rest_type") @db.VarChar(30)
  restDurationHours     Float?       @map("rest_duration_hours")
  restReason            String?      @map("rest_reason") @db.Text
  fuelGallons           Float?       @map("fuel_gallons")
  fuelCostEstimate      Float?       @map("fuel_cost_estimate")
  fuelStationName       String?      @map("fuel_station_name") @db.VarChar(200)
  dockDurationHours     Float?       @map("dock_duration_hours")
  customerName          String?      @map("customer_name") @db.VarChar(200)
  hosStateAfter         Json?        @map("hos_state_after")
  estimatedArrival      DateTime?    @map("estimated_arrival") @db.Timestamptz
  estimatedDeparture    DateTime?    @map("estimated_departure") @db.Timestamptz

  // Geo coordinates
  fromLat                 Float?     @map("from_lat")
  fromLon                 Float?     @map("from_lon")
  toLat                   Float?     @map("to_lat")
  toLon                   Float?     @map("to_lon")

  // Timezone
  timezone                String?    @db.VarChar(50)

  // Dock segment details
  actionType              String?    @map("action_type") @db.VarChar(20)
  appointmentWindow       Json?      @map("appointment_window")

  // Fuel segment details
  fuelPricePerGallon      Float?     @map("fuel_price_per_gallon")
  detourMiles             Float?     @map("detour_miles")

  // Rest segment details
  isDocktimeConverted     Boolean    @default(false) @map("is_docktime_converted")

  // Weather
  weatherAlerts           Json?      @map("weather_alerts")

  // Map display
  routeGeometry           String?    @map("route_geometry") @db.Text

  // Actual tracking
  actualArrival           DateTime?  @map("actual_arrival") @db.Timestamptz
  actualDeparture         DateTime?  @map("actual_departure") @db.Timestamptz

  // Fuel state tracking
  fuelStateAfter          Json?      @map("fuel_state_after")

  // Stop reference
  stopId                  Int?       @map("stop_id")
  stop                    Stop?      @relation(fields: [stopId], references: [id])

  status                String       @default("planned") @db.VarChar(20)
  createdAt             DateTime     @default(now()) @map("created_at") @db.Timestamptz

  plan                  RoutePlan    @relation(fields: [planId], references: [id])

  @@index([planId, sequenceOrder])
  @@map("route_segments")
}

model RoutePlanUpdate {
  id                    Int          @id @default(autoincrement())
  updateId              String       @unique @map("update_id") @db.VarChar(50)
  planId                Int          @map("plan_id")
  updateType            String       @map("update_type") @db.VarChar(50)
  triggeredAt           DateTime     @map("triggered_at") @db.Timestamptz
  triggeredBy           String       @map("triggered_by") @db.VarChar(50)
  triggerData           Json?        @map("trigger_data")
  replanTriggered       Boolean      @default(false) @map("replan_triggered")
  replanReason          String?      @map("replan_reason") @db.Text
  previousPlanVersion   Int?         @map("previous_plan_version")
  newPlanVersion        Int?         @map("new_plan_version")
  impactSummary         Json?        @map("impact_summary")
  createdAt             DateTime     @default(now()) @map("created_at") @db.Timestamptz

  plan                  RoutePlan    @relation(fields: [planId], references: [id])

  @@index([planId])
  @@map("route_plan_updates")
}

model Stop {
  id                    Int          @id @default(autoincrement())
  stopId                String       @unique @map("stop_id") @db.VarChar(50)
  name                  String       @db.VarChar(200)
  address               String?      @db.Text
  city                  String?      @db.VarChar(100)
  state                 String?      @db.VarChar(50)
  lat                   Float?
  lon                   Float?
  locationType          String       @default("warehouse") @map("location_type") @db.VarChar(30)
  isActive              Boolean      @default(true) @map("is_active")

  zipCode                 String?    @map("zip_code") @db.VarChar(10)
  timezone                String?    @db.VarChar(50)

  // Fuel station fields
  fuelPricePerGallon      Float?     @map("fuel_price_per_gallon")
  fuelPriceUpdatedAt      DateTime?  @map("fuel_price_updated_at") @db.Timestamptz
  fuelBrand               String?    @map("fuel_brand") @db.VarChar(50)

  // Truck stop fields
  amenities               Json?
  parkingSpaces           Int?       @map("parking_spaces")

  // Multi-tenancy (optional)
  tenantId                Int?       @map("tenant_id")

  createdAt             DateTime     @default(now()) @map("created_at") @db.Timestamptz

  loadStops             LoadStop[]
  routeSegments         RouteSegment[]

  @@map("stops")
}

model Load {
  id                    Int          @id @default(autoincrement())
  loadId                String       @unique @map("load_id") @db.VarChar(50)
  loadNumber            String       @map("load_number") @db.VarChar(50)
  status                String       @default("pending") @db.VarChar(30)
  weightLbs             Float        @map("weight_lbs")
  commodityType         String       @map("commodity_type") @db.VarChar(100)
  specialRequirements   String?      @map("special_requirements") @db.Text
  customerName          String       @map("customer_name") @db.VarChar(200)
  isActive              Boolean      @default(true) @map("is_active")
  createdAt             DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime     @updatedAt @map("updated_at") @db.Timestamptz

  // External system linkage (for integration sync)
  externalLoadId        String?      @map("external_load_id") @db.VarChar(100)
  externalSource        IntegrationVendor?  @map("external_source")
  lastSyncedAt          DateTime?    @map("last_synced_at") @db.Timestamptz

  tenantId                Int        @map("tenant_id")
  tenant                  Tenant     @relation(fields: [tenantId], references: [id])

  @@index([tenantId])

  stops                 LoadStop[]
  routePlanLoads        RoutePlanLoad[]

  @@unique([externalLoadId])
  @@map("loads")
}

model LoadStop {
  id                    Int          @id @default(autoincrement())
  loadId                Int          @map("load_id")
  stopId                Int          @map("stop_id")
  sequenceOrder         Int          @map("sequence_order")
  actionType            String       @map("action_type") @db.VarChar(20)
  earliestArrival       String?      @map("earliest_arrival") @db.VarChar(10)
  latestArrival         String?      @map("latest_arrival") @db.VarChar(10)
  estimatedDockHours    Float        @map("estimated_dock_hours")
  actualDockHours       Float?       @map("actual_dock_hours")
  createdAt             DateTime     @default(now()) @map("created_at") @db.Timestamptz

  load                  Load         @relation(fields: [loadId], references: [id])
  stop                  Stop         @relation(fields: [stopId], references: [id])

  @@index([loadId])
  @@map("load_stops")
}


model RoutePlanLoad {
  id          Int       @id @default(autoincrement())
  planId      Int       @map("plan_id")
  loadId      Int       @map("load_id")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz

  plan        RoutePlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  load        Load      @relation(fields: [loadId], references: [id])

  @@unique([planId, loadId])
  @@index([planId])
  @@index([loadId])
  @@map("route_plan_loads")
}

model Event {
  id                    Int          @id @default(autoincrement())
  eventId               String       @unique @map("event_id") @db.VarChar(50)
  eventType             String       @map("event_type") @db.VarChar(50)
  entityType            String       @map("entity_type") @db.VarChar(50)
  entityId              Int?         @map("entity_id")
  eventData             Json?        @map("event_data")
  createdAt             DateTime     @default(now()) @map("created_at") @db.Timestamptz

  @@index([entityType, entityId])
  @@map("events")
}

model Recommendation {
  id                    Int          @id @default(autoincrement())
  recommendationId      String       @unique @map("recommendation_id") @db.VarChar(50)
  driverId              String       @map("driver_id") @db.VarChar(50)
  recommendation        String       @db.VarChar(30)
  duration              Float?
  confidence            Int          @default(0)
  reasoning             String       @db.Text
  createdAt             DateTime     @default(now()) @map("created_at") @db.Timestamptz

  @@map("recommendations")
}

model Alert {
  id                    Int          @id @default(autoincrement())
  alertId               String       @unique @map("alert_id") @db.VarChar(50)
  tenantId              Int          @map("tenant_id")

  // Context
  driverId              String       @map("driver_id") @db.VarChar(50)
  routePlanId           String?      @map("route_plan_id") @db.VarChar(50)
  vehicleId             String?      @map("vehicle_id") @db.VarChar(50)

  // Classification
  alertType             String       @map("alert_type") @db.VarChar(50)
  category              String       @default("system") @db.VarChar(30)
  priority              String       @db.VarChar(20)

  // Content
  title                 String       @db.VarChar(200)
  message               String       @db.Text
  recommendedAction     String?      @map("recommended_action") @db.Text
  metadata              Json?

  // Lifecycle
  status                String       @default("active") @db.VarChar(20)
  acknowledgedAt        DateTime?    @map("acknowledged_at") @db.Timestamptz
  acknowledgedBy        String?      @map("acknowledged_by") @db.VarChar(50)
  snoozedUntil          DateTime?    @map("snoozed_until") @db.Timestamptz
  resolvedAt            DateTime?    @map("resolved_at") @db.Timestamptz
  resolvedBy            String?      @map("resolved_by") @db.VarChar(50)
  resolutionNotes       String?      @map("resolution_notes") @db.Text
  autoResolved          Boolean      @default(false) @map("auto_resolved")
  autoResolveReason     String?      @map("auto_resolve_reason") @db.Text

  // Grouping
  parentAlertId         String?      @map("parent_alert_id") @db.VarChar(50)
  groupKey              String?      @map("group_key") @db.VarChar(200)

  // Escalation
  escalationLevel       Int          @default(0) @map("escalation_level")
  escalatedAt           DateTime?    @map("escalated_at") @db.Timestamptz

  // Deduplication
  dedupKey              String?      @map("dedup_key") @db.VarChar(200)

  // Timestamps
  createdAt             DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime     @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tenant                Tenant       @relation(fields: [tenantId], references: [id])
  notes                 AlertNote[]
  parentAlert           Alert?       @relation("AlertGroup", fields: [parentAlertId], references: [alertId])
  childAlerts           Alert[]      @relation("AlertGroup")

  @@index([tenantId, status, priority, createdAt])
  @@index([tenantId, createdAt])
  @@index([dedupKey, status])
  @@index([driverId, status])
  @@index([routePlanId, status])
  @@index([parentAlertId])
  @@index([groupKey])
  @@index([snoozedUntil])
  @@map("alerts")
}

model AlertNote {
  id            Int       @id @default(autoincrement())
  noteId        String    @unique @default(cuid()) @map("note_id") @db.VarChar(50)
  alertId       String    @map("alert_id") @db.VarChar(50)
  authorId      String    @map("author_id") @db.VarChar(50)
  authorName    String    @map("author_name") @db.VarChar(200)
  content       String    @db.Text
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz

  alert         Alert     @relation(fields: [alertId], references: [alertId])

  @@index([alertId, createdAt])
  @@map("alert_notes")
}

model AlertConfiguration {
  id              Int       @id @default(autoincrement())
  tenantId        Int       @unique @map("tenant_id")

  alertTypes      Json      @map("alert_types")
  escalationPolicy Json     @map("escalation_policy")
  groupingConfig  Json      @map("grouping_config")
  defaultChannels Json      @map("default_channels")

  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  tenant          Tenant    @relation(fields: [tenantId], references: [id])

  @@map("alert_configurations")
}

model ShiftNote {
  id            Int       @id @default(autoincrement())
  noteId        String    @unique @default(cuid()) @map("note_id") @db.VarChar(50)
  tenantId      Int       @map("tenant_id")
  content       String    @db.Text
  createdBy     Int       @map("created_by")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  expiresAt     DateTime  @map("expires_at") @db.Timestamptz
  isPinned      Boolean   @default(false) @map("is_pinned")
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz

  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  createdByUser User      @relation(fields: [createdBy], references: [id])

  @@index([tenantId, deletedAt, expiresAt])
  @@map("shift_notes")
}


// ============================================================================
// INTEGRATION MODELS
// ============================================================================

enum IntegrationType {
  TMS
  HOS_ELD
  FUEL_PRICE
  WEATHER
  TELEMATICS
}

enum IntegrationVendor {
  MCLEOD_TMS
  TMW_TMS
  PROJECT44_TMS
  SAMSARA_ELD
  KEEPTRUCKIN_ELD
  MOTIVE_ELD
  GASBUDDY_FUEL
  FUELFINDER_FUEL
  OPENWEATHER
}

enum IntegrationStatus {
  NOT_CONFIGURED
  CONFIGURED
  ACTIVE
  ERROR
  DISABLED
}

model IntegrationConfig {
  id                    Int                  @id @default(autoincrement())
  integrationId         String               @unique @map("integration_id") @db.VarChar(50)

  tenant                Tenant               @relation(fields: [tenantId], references: [id])
  tenantId              Int                  @map("tenant_id")

  integrationType       IntegrationType      @map("integration_type")
  vendor                IntegrationVendor
  displayName           String               @map("display_name") @db.VarChar(200)
  isEnabled             Boolean              @default(false) @map("is_enabled")
  status                IntegrationStatus    @default(NOT_CONFIGURED)

  // Encrypted credentials (JSON stored as text)
  credentials           Json?

  // Sync settings
  syncIntervalSeconds   Int?                 @map("sync_interval_seconds")

  // Health monitoring
  lastSyncAt            DateTime?            @map("last_sync_at") @db.Timestamptz
  lastSuccessAt         DateTime?            @map("last_success_at") @db.Timestamptz
  lastErrorAt           DateTime?            @map("last_error_at") @db.Timestamptz
  lastErrorMessage      String?              @map("last_error_message") @db.Text

  createdAt             DateTime             @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime             @updatedAt @map("updated_at") @db.Timestamptz

  syncLogs              IntegrationSyncLog[]

  @@unique([tenantId, integrationType, vendor])
  @@index([tenantId])
  @@index([status])
  @@map("integration_configs")
}

model IntegrationSyncLog {
  id                    Int                  @id @default(autoincrement())
  logId                 String               @unique @map("log_id") @db.VarChar(50)

  integration           IntegrationConfig    @relation(fields: [integrationId], references: [id])
  integrationId         Int                  @map("integration_id")

  syncType              String               @map("sync_type") @db.VarChar(20)
  startedAt             DateTime             @map("started_at") @db.Timestamptz
  completedAt           DateTime?            @map("completed_at") @db.Timestamptz

  status                String               @db.VarChar(20)
  recordsProcessed      Int                  @default(0) @map("records_processed")
  recordsCreated        Int                  @default(0) @map("records_created")
  recordsUpdated        Int                  @default(0) @map("records_updated")

  errorDetails          Json?                @map("error_details")

  createdAt             DateTime             @default(now()) @map("created_at") @db.Timestamptz

  @@index([integrationId, startedAt])
  @@map("integration_sync_logs")
}

// ============================================================================
// USER PREFERENCES MODELS
// ============================================================================

model UserPreferences {
  id                        Int       @id @default(autoincrement())
  userId                    Int       @unique @map("user_id")
  user                      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Display Preferences
  distanceUnit              String    @default("MILES")  @map("distance_unit") @db.VarChar(20)  // MILES | KILOMETERS
  timeFormat                String    @default("12H")    @map("time_format") @db.VarChar(10)  // 12H | 24H
  temperatureUnit           String    @default("F")      @map("temperature_unit") @db.VarChar(5)   // F | C
  currency                  String    @default("USD")    @db.VarChar(10)
  timezone                  String    @default("America/New_York") @db.VarChar(100)
  dateFormat                String    @default("MM/DD/YYYY") @map("date_format") @db.VarChar(20)

  // Dashboard Preferences
  autoRefreshInterval       Int       @default(30)       @map("auto_refresh_interval") // seconds, 0 = manual
  defaultView               String    @default("OVERVIEW") @map("default_view") @db.VarChar(30) // OVERVIEW | TIMELINE | MAP | COMPLIANCE | COSTS
  compactMode               Boolean   @default(false)    @map("compact_mode")
  highContrastMode          Boolean   @default(false)    @map("high_contrast_mode")

  // Alert Delivery (per-priority channel overrides)
  // User's override of tenant defaults. Empty = use tenant defaults.
  // Shape: { "critical": { "inApp": true, "email": true, "push": true, "sms": true }, ... }
  alertChannels             Json      @default("{}") @map("alert_channels")
  minAlertPriority          String    @default("LOW") @map("min_alert_priority") @db.VarChar(20)
  alertCategories           Json      @default("[\"hos\",\"delay\",\"route\",\"driver\",\"vehicle\",\"external\"]") @map("alert_categories")

  // Sound & Browser
  soundSettings             Json      @default("{\"critical\":true,\"high\":true,\"medium\":false,\"low\":false}") @map("sound_settings")
  browserNotifications      Boolean   @default(true)     @map("browser_notifications")
  flashTabOnCritical        Boolean   @default(true)     @map("flash_tab_on_critical")

  // Quiet Hours
  quietHoursEnabled         Boolean   @default(false)    @map("quiet_hours_enabled")
  quietHoursStart           String?   @map("quiet_hours_start") @db.VarChar(10)
  quietHoursEnd             String?   @map("quiet_hours_end") @db.VarChar(10)

  // Snooze & Digest
  defaultSnoozeDuration     Int       @default(15)       @map("default_snooze_duration")
  emailDigestFrequency      String    @default("NEVER")  @map("email_digest_frequency") @db.VarChar(20)

  // Accessibility
  fontSize                  String    @default("MEDIUM") @map("font_size") @db.VarChar(10) // SMALL | MEDIUM | LARGE | XL
  reduceMotion              Boolean   @default(false)    @map("reduce_motion")
  screenReaderOptimized     Boolean   @default(false)    @map("screen_reader_optimized")

  createdAt                 DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                 DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@index([userId])
  @@map("user_preferences")
}

model FleetOperationsSettings {
  id                        Int       @id @default(autoincrement())
  tenantId                  Int       @unique @map("tenant_id")
  tenant                    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // HOS Defaults
  defaultDriveHours         Float     @default(0.0)      @map("default_drive_hours")
  defaultOnDutyHours        Float     @default(0.0)      @map("default_on_duty_hours")
  defaultSinceBreakHours    Float     @default(0.0)      @map("default_since_break_hours")

  // Optimization Defaults
  defaultOptimizationMode   String    @default("BALANCE") @map("default_optimization_mode") @db.VarChar(30)
  costPerMile               Float     @default(1.85)     @map("cost_per_mile")
  laborCostPerHour          Float     @default(25.0)     @map("labor_cost_per_hour")

  // Rest Insertion Preferences
  preferFullRest            Boolean   @default(true)     @map("prefer_full_rest")
  restStopBuffer            Int       @default(30)       @map("rest_stop_buffer")
  allowDockRest             Boolean   @default(true)     @map("allow_dock_rest")
  minRestDuration           Int       @default(7)        @map("min_rest_duration")

  // Fuel Preferences
  fuelPriceThreshold        Float     @default(0.15)     @map("fuel_price_threshold")
  maxFuelDetour             Int       @default(10)       @map("max_fuel_detour")
  minFuelSavings            Float     @default(10.0)     @map("min_fuel_savings")

  // Route Planning Defaults
  defaultLoadAssignment     String    @default("MANUAL") @map("default_load_assignment") @db.VarChar(30)
  defaultDriverSelection    String    @default("AUTO_SUGGEST") @map("default_driver_selection") @db.VarChar(30)
  defaultVehicleSelection   String    @default("AUTO_ASSIGN") @map("default_vehicle_selection") @db.VarChar(30)

  // Report Preferences
  reportTimezone            String    @default("America/New_York") @map("report_timezone") @db.VarChar(100)
  includeMapInReports       Boolean   @default(true)     @map("include_map_in_reports")
  reportEmailRecipients     Json      @default("[]")     @map("report_email_recipients")

  createdAt                 DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                 DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@index([tenantId])
  @@map("operations_settings")
}

model DriverPreferences {
  id                        Int       @id @default(autoincrement())
  userId                    Int       @unique @map("user_id")
  user                      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  driverId                  Int?      @unique @map("driver_id")
  driver                    Driver?   @relation(fields: [driverId], references: [id], onDelete: SetNull)

  // Preferred Locations (favorite truck stops)
  preferredRestStops        Json      @default("[]")     @map("preferred_rest_stops") // [{name, lat, lng, amenities}]
  preferredFuelStops        Json      @default("[]")     @map("preferred_fuel_stops") // [{name, lat, lng, brand}]

  // Break Preferences
  preferredBreakDuration    Int       @default(30)       @map("preferred_break_duration") // minutes
  breakReminderAdvance      Int       @default(30)       @map("break_reminder_advance") // minutes before HOS limit

  // Route Display
  timelineView              String    @default("VERTICAL") @map("timeline_view") @db.VarChar(20) // VERTICAL | HORIZONTAL
  showRestReasoning         Boolean   @default(true)     @map("show_rest_reasoning") // Show why rest was inserted
  showCostDetails           Boolean   @default(false)    @map("show_cost_details") // Hide costs from drivers

  // Mobile Preferences
  largeTextMode             Boolean   @default(false)    @map("large_text_mode")
  offlineMode               Boolean   @default(false)    @map("offline_mode") // Cache data for offline
  dataUsageMode             String    @default("NORMAL") @map("data_usage_mode") @db.VarChar(20) // LOW | NORMAL | HIGH

  // Communication
  emergencyContact          String?   @map("emergency_contact") @db.VarChar(50) // Phone number
  preferredContactMethod    String    @default("IN_APP") @map("preferred_contact_method") @db.VarChar(20) // IN_APP | SMS | PHONE
  languagePreference        String    @default("en")     @map("language_preference") @db.VarChar(10) // ISO language code

  createdAt                 DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                 DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  @@index([userId])
  @@index([driverId])
  @@map("driver_preferences")
}

// ============================================================================
// FEATURE FLAGS MODEL
// ============================================================================

model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique @db.VarChar(100)
  name        String   @db.VarChar(200)
  description String?  @db.Text
  enabled     Boolean  @default(false)
  category    String   @default("general") @db.VarChar(50)  // general | dispatcher | driver | admin
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@index([key])
  @@index([category])
  @@index([enabled])
  @@map("feature_flags")
}

// ============================================================================
// NOTIFICATION MODELS
// ============================================================================

enum NotificationType {
  // Existing
  USER_INVITATION
  TENANT_REGISTRATION_CONFIRMATION
  TENANT_APPROVED
  TENANT_REJECTED

  // System Events
  ROUTE_PLANNED
  ROUTE_UPDATED
  ROUTE_COMPLETED
  INTEGRATION_SYNCED
  INTEGRATION_FAILED

  // Team Events
  USER_JOINED
  ROLE_CHANGED
  DRIVER_ACTIVATED
  SETTINGS_UPDATED

  // Operations
  LOAD_ASSIGNED
  LOAD_STATUS_CHANGED
  SCHEDULE_CHANGED

  // Communications
  DISPATCH_MESSAGE
  ACKNOWLEDGMENT_REQUEST
  ACKNOWLEDGMENT_RECEIVED
}

enum NotificationChannel {
  EMAIL
  SMS      // Future
  PUSH     // Future
  IN_APP   // Future
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

model Notification {
  id              Int                 @id @default(autoincrement())
  notificationId  String              @unique @default(cuid()) @map("notification_id") @db.VarChar(50)

  // Notification details
  type            NotificationType
  channel         NotificationChannel @default(EMAIL)
  recipient       String              @db.VarChar(255)
  status          NotificationStatus  @default(PENDING)

  // Related entities (nullable - depends on notification type)
  tenantId        Int?                @map("tenant_id")
  tenant          Tenant?             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId          Int?                @map("user_id")
  user            User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  invitationId    Int?                @map("invitation_id")
  invitation      UserInvitation?     @relation(fields: [invitationId], references: [id], onDelete: Cascade)

  // In-App Notification fields
  category        String?             @db.VarChar(30)
  title           String?             @db.VarChar(255)
  message         String?             @db.Text
  actionUrl       String?             @map("action_url") @db.VarChar(500)
  actionLabel     String?             @map("action_label") @db.VarChar(100)
  iconType        String?             @map("icon_type") @db.VarChar(30)
  readAt          DateTime?           @map("read_at") @db.Timestamptz
  dismissedAt     DateTime?           @map("dismissed_at") @db.Timestamptz

  // Metadata
  metadata        Json?
  errorMessage    String?             @map("error_message") @db.Text
  sentAt          DateTime?           @map("sent_at")

  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([tenantId, status])
  @@index([type, status])
  @@index([userId, readAt, dismissedAt])
  @@index([userId, category, createdAt])
  @@map("notifications")
}

// ============================================================================
// PUSH SUBSCRIPTIONS
// ============================================================================

model PushSubscription {
  id              Int       @id @default(autoincrement())
  userId          Int       @map("user_id")
  tenantId        Int       @map("tenant_id")
  endpoint        String    @db.Text
  p256dh          String    @db.VarChar(200)
  auth            String    @db.VarChar(100)
  userAgent       String?   @map("user_agent") @db.VarChar(500)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  user            User      @relation(fields: [userId], references: [id])

  @@unique([userId, endpoint])
  @@index([userId])
  @@map("push_subscriptions")
}

// ============================================================================
// SALLY AI CONVERSATION MODELS
// ============================================================================

model Conversation {
  id                Int                   @id @default(autoincrement())
  conversationId    String                @unique @map("conversation_id") @db.VarChar(50)

  tenant            Tenant                @relation(fields: [tenantId], references: [id])
  tenantId          Int                   @map("tenant_id")

  user              User                  @relation(fields: [userId], references: [id])
  userId            Int                   @map("user_id")

  userMode          String                @map("user_mode") @db.VarChar(20)
  title             String?               @db.VarChar(255)
  isActive          Boolean               @default(true) @map("is_active")

  createdAt         DateTime              @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime              @updatedAt @map("updated_at") @db.Timestamptz

  messages          ConversationMessage[]

  @@index([tenantId, userId, createdAt])
  @@map("conversations")
}

model ConversationMessage {
  id                Int                   @id @default(autoincrement())
  messageId         String                @unique @map("message_id") @db.VarChar(50)

  conversation      Conversation          @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId    Int                   @map("conversation_id")

  role              String                @db.VarChar(20)
  content           String                @db.Text
  inputMode         String                @map("input_mode") @db.VarChar(10)
  intent            String?               @db.VarChar(50)
  card              Json?
  action            Json?
  speakText         String?               @map("speak_text") @db.Text

  createdAt         DateTime              @default(now()) @map("created_at") @db.Timestamptz

  @@index([conversationId, createdAt])
  @@map("conversation_messages")
}
