# Scheduled Jobs

SALLY uses `@nestjs/schedule` for cron-based background jobs. Each job is a dedicated `@Injectable()` class with a `@Cron()` decorator on its main method.

## Quick Reference

| Job | Default Frequency | File | Purpose |
|-----|-------------------|------|---------|
| Drivers Sync | Every 15 min | `infrastructure/jobs/drivers-sync.job.ts` | Syncs driver rosters (TMS creates, ELD enriches) |
| Vehicles Sync | Every 15 min | `infrastructure/jobs/vehicles-sync.job.ts` | Syncs vehicle data (TMS creates, ELD enriches) |
| Loads Sync | Every 15 min | `infrastructure/jobs/loads-sync.job.ts` | Syncs active loads from TMS |
| HOS Sync | Every 5 min | `infrastructure/jobs/hos-sync.job.ts` | Syncs HOS hours per driver from ELD |
| Telematics Sync | Every 2 min | `infrastructure/jobs/telematics-sync.job.ts` | Syncs vehicle location, speed, fuel from ELD |
| Fuel Price Sync | Every hour | `infrastructure/jobs/fuel-price-sync.job.ts` | Syncs fuel prices (Phase 3 placeholder) |
| Weather Sync | Every 30 min | `infrastructure/jobs/weather-sync.job.ts` | Syncs weather data (Phase 3 placeholder) |
| Sync Log Cleanup | Daily at 2 AM | `infrastructure/jobs/sync-log-cleanup.job.ts` | Deletes sync logs older than 30 days |
| Alert Escalation | Every minute | `operations/alerts/services/escalation.service.ts` | Escalates unacknowledged alerts past SLA |
| Snooze Expiry | Every minute | `operations/alerts/services/auto-resolution.service.ts` | Reactivates alerts whose snooze period expired |
| Alert Digest | Configurable | `operations/alerts/services/alert-digest.service.ts` | Sends periodic alert digest summaries |

## Data-Type Sync Jobs

### Architecture

Jobs are organized by **data type**, not by integration source. Each job syncs one kind of data across all relevant integrations:

```
DriversSyncJob (every 15 min)
  → TMS integrations: creates/updates drivers (source of truth)
  → ELD integrations: enriches drivers with ELD metadata

VehiclesSyncJob (every 15 min)
  → TMS integrations: creates/updates vehicles (source of truth)
  → ELD integrations: enriches vehicles with telematics metadata

LoadsSyncJob (every 15 min)
  → TMS integrations only: syncs active loads and stops

HosSyncJob (every 5 min)
  → Deduplicates by tenant (one sync per tenant, not per integration)
  → Calls IntegrationManagerService.syncAllDriversForTenant()

TelematicsSyncJob (every 2 min)
  → ELD integrations: fetches vehicle locations via adapter
  → Matches vehicles by VIN or ELD ID
  → Upserts into vehicle_telematics table
```

### Configurable Timing

All sync job frequencies can be overridden via environment variables:

| Variable | Default | Description |
|----------|---------|-------------|
| `SYNC_DRIVERS_CRON` | `0 */15 * * * *` | Driver roster sync interval |
| `SYNC_VEHICLES_CRON` | `0 */15 * * * *` | Vehicle data sync interval |
| `SYNC_LOADS_CRON` | `0 */15 * * * *` | Active loads sync interval |
| `SYNC_HOS_CRON` | `0 */5 * * * *` | HOS hours sync interval |
| `SYNC_TELEMATICS_CRON` | `0 */2 * * * *` | Vehicle telematics sync interval |

### Error Handling

All sync jobs follow the same error handling pattern:
- Each integration sync is wrapped in a try-catch
- If one integration fails, the job continues with the next
- Errors are logged with integration and tenant context

### Registration

Data-type sync jobs are registered as providers in `SyncModule` (`domains/integrations/sync/sync.module.ts`), except `HosSyncJob` which is registered in `IntegrationsModule` (depends on `IntegrationManagerService`).

## Alert Jobs

Alert jobs live in their respective service files within the alerts domain. All alert cron methods wrap their body in a try-catch to prevent unhandled exceptions from crashing the scheduler.

## Adding a New Job

1. Create `apps/backend/src/infrastructure/jobs/your-job.job.ts`
2. Add the `@Injectable()` decorator and inject dependencies
3. Add `@Cron(process.env.YOUR_CRON_VAR || 'default-expression')` with the desired schedule
4. Wrap the method body in try-catch for error resilience
5. Register the job as a provider in the appropriate module
6. Write tests in `apps/backend/src/infrastructure/jobs/__tests__/`
7. Add the env var to `.env.example`

### Frequency Guide

| Data Type | Suggested Interval | Rationale |
|-----------|-------------------|-----------|
| Telematics | 2 minutes | Real-time vehicle location tracking |
| HOS | 5 minutes | HOS changes frequently during driving |
| Drivers / Vehicles / Loads | 15 minutes | Fleet data changes less frequently |
| Fuel prices | 1 hour | Prices update infrequently |
| Weather | 30 minutes | Conditions change moderately |
| Cleanup | Daily | Housekeeping, low urgency |

## `ScheduleModule` Configuration

`ScheduleModule.forRoot()` is registered once in `AppModule` (the root module). Individual modules should **not** call `forRoot()` again.
