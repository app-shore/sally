{
  "schemaVersion": 2,
  "dockerfileLines": [
    "FROM node:20-alpine AS frontend-builder",
    "WORKDIR /app",
    "COPY package*.json ./",
    "COPY apps/web/package*.json ./apps/web/",
    "RUN npm ci --workspaces=false --workspace=apps/web",
    "COPY apps/web ./apps/web",
    "RUN cd apps/web && npm run build",
    "",
    "FROM python:3.11-slim",
    "RUN apt-get update && apt-get install -y curl nodejs npm && rm -rf /var/lib/apt/lists/*",
    "RUN pip install uv supervisor",
    "",
    "WORKDIR /app",
    "COPY apps/backend ./backend",
    "RUN cd backend && uv sync",
    "",
    "COPY --from=frontend-builder /app/apps/web/.next ./web/.next",
    "COPY --from=frontend-builder /app/apps/web/package*.json ./web/",
    "COPY --from=frontend-builder /app/apps/web/public ./web/public",
    "COPY apps/web/next.config.ts ./web/",
    "COPY package*.json ./",
    "RUN npm ci --omit=dev --workspace=apps/web",
    "",
    "COPY deploy/supervisord.conf /etc/supervisor/conf.d/supervisord.conf",
    "",
    "EXPOSE 3000 8000",
    "",
    "CMD [\"/usr/local/bin/supervisord\", \"-c\", \"/etc/supervisor/conf.d/supervisord.conf\"]"
  ]
}
